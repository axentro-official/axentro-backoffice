<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Axentro - ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª</title>

  <!-- Runtime config (same folder) -->
  <script src="./config.js"></script>

  <!-- QR/Barcode scanner -->
<style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:rgba(15,23,42,.12);
      --brand:#0ea5e9;
      --danger:#ef4444;
      --ok:#16a34a;
      --shadow:0 12px 30px rgba(2,6,23,.10);
      --radius:18px;
      --pad:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans Arabic","Noto Kufi Arabic","Cairo",sans-serif;
      background: radial-gradient(1000px 500px at 15% 5%, #fde68a22, transparent 60%),
                  radial-gradient(1000px 500px at 85% 10%, #38bdf822, transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:28px auto;padding:0 14px;}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px;
      overflow:hidden;
    }
    .top{
      display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      margin-bottom:16px;
    }
    .brand{
      display:flex;gap:10px;align-items:center;
    }
    .logo{
      width:44px;height:44px;border-radius:999px;
      display:grid;place-items:center;
      border:1px solid #f59e0b55;background:#fff7ed;
      font-weight:800;
    }
    h1{margin:0;font-size:24px;letter-spacing:.2px}
    .sub{color:var(--muted);margin-top:4px;font-size:13px}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border-radius:999px;border:1px solid var(--border);
      background:#fff;
      color:var(--muted);
      font-size:13px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (max-width:860px){ .grid{grid-template-columns:1fr} }
    .sec-title{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin:10px 0 10px;
      font-weight:800;
    }
    .hint{color:var(--muted);font-size:12px;line-height:1.6}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){ .row{grid-template-columns:1fr} }
    label{display:block;font-size:12px;color:var(--muted);margin:6px 2px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:86px;resize:vertical}
    input:focus, textarea:focus, select:focus{border-color:#38bdf8aa; box-shadow:0 0 0 4px #38bdf822}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{
      border:0;
      border-radius:14px;
      padding:11px 14px;
      font-weight:700;
      cursor:pointer;
      background:#0f172a;
      color:#fff;
    }
    button.secondary{background:#f1f5f9;color:#0f172a;border:1px solid var(--border)}
    button.brand{background:var(--brand)}
    button.danger{background:var(--danger)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .msg{
      margin:12px 0 0;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      display:none;
      font-size:13px;
      line-height:1.6;
    }
    .msg.ok{display:block;border-color:#16a34a55;background:#16a34a10;color:#14532d}
    .msg.err{display:block;border-color:#ef444455;background:#ef444410;color:#7f1d1d}
    .tbl{
      width:100%;
      border-collapse:separate;
      border-spacing:0 10px;
      margin-top:8px;
    }
    .tbl th{
      text-align:right;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      padding:6px 8px;
    }
    .tbl td{
      background:#fff;
      border:1px solid var(--border);
      padding:10px 8px;
      font-size:13px;
    }
    .tbl tr td:first-child{border-radius:14px 0 0 14px}
    .tbl tr td:last-child{border-radius:0 14px 14px 0}
    .mono{font-family:var(--mono);direction:ltr;text-align:left}
    .totals{
      margin-top:12px;
      padding:14px;
      border:1px dashed var(--border);
      border-radius:14px;
      background:#fff;
    }
    .trow{display:flex;justify-content:space-between;gap:10px;margin:6px 0}
    .trow strong{font-size:14px}
    .small{font-size:12px;color:var(--muted)}
    /* Scanner modal */
    .modal{
      position:fixed;inset:0;display:none;place-items:center;
      background:rgba(2,6,23,.55);
      padding:18px;
      z-index:9999;
    }
    .modal.open{display:grid}
    .modal .box{
      width:min(520px, 100%);
      background:#fff;
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modal .hd{
      padding:12px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid var(--border);
      font-weight:900;
    }
    .modal .bd{padding:12px 14px}
    #qr-reader{width:100%}
    .foot{
      text-align:center;
      color:var(--muted);
      font-size:12px;
      margin-top:14px;
    }
  
  #scanVideo{
    width:100%;
    max-height:60vh;
    border-radius:12px;
    background:#000;
  }
  .scan-hint{
    margin-top:10px;
    font-size:14px;
    color:#6b7280;
    text-align:center;
  }

    .tbl-wrap{width:100%; overflow:auto; -webkit-overflow-scrolling:touch;}
    .tbl{min-width:720px}
    .switch{
      display:inline-flex;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--muted);
      font-size:13px;
      user-select:none;
    }
    .switch input{width:auto; accent-color: var(--brand)}
    @media (max-width:520px){
      .card{padding:16px}
      h1{font-size:20px}
      .btns button{flex:1}
      .switch{width:100%; justify-content:center}
    }


  .scan-wrap{position:relative}
  .scan-target{
    position:absolute;
    inset:0;
    pointer-events:none;
    display:block;
  }
  .scan-target:before{
    content:"";
    position:absolute;
    left:50%;
    top:50%;
    width:min(78vw, 420px);
    height:min(34vh, 200px);
    transform:translate(-50%,-50%);
    border:3px solid rgba(14,165,233,.95);
    border-radius:14px;
    box-shadow:0 0 0 9999px rgba(0,0,0,.22);
  }


    #torchBtn[disabled]{opacity:.55; cursor:not-allowed}

</style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="brand">
          <div class="logo">AX</div>
          <div>
            <h1>ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª</h1>
            <div class="sub">Purchase Invoice â€¢ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø£Ùˆ Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</div>
          </div>
        </div>
        <div class="pill" id="cfg-pill">Config: <span class="mono" id="cfg-state">â€¦</span></div>
      </div>

      <div class="grid">
        <!-- Left: invoice + items -->
        <div>
          <div class="sec-title">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© <span class="hint">Ù…Ø·Ù„ÙˆØ¨: Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© + Ø§Ù„Ù…ÙˆØ±Ø¯ + Ø§Ù„ØªØ§Ø±ÙŠØ®</span></div>
          <div class="row">
            <div>
              <label>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
              <input id="invNo" placeholder="Ù…Ø«Ø§Ù„: PINV-20260209-001" />
            </div>
            <div>
              <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
              <input id="invDate" type="date" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Ø§Ù„Ù…ÙˆØ±Ø¯</label>
              <input id="supplier" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯" />
            </div>
            <div>
              <label>Ù…Ø±Ø¬Ø¹ / Ù…Ù„Ø§Ø­Ø¸Ø©</label>
              <input id="ref" placeholder="Ref / Note" />
            </div>
          </div>

          <div style="height:8px"></div>

          <div class="sec-title">Ø§Ù„Ø£ØµÙ†Ø§Ù</div>

          <div class="row">
            <div>
              <label>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <input id="barcode" class="mono" placeholder="Scan / Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯" inputmode="numeric" />
            </div>
            <div>
              <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ù„Ùˆ Ù…ÙÙŠØ´ Ø¨Ø§Ø±ÙƒÙˆØ¯)</label>
              <input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</label>
              <input id="cost" type="number" step="0.01" placeholder="0.00" />
            </div>
            <div>
              <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
              <input id="qty" type="number" step="1" placeholder="1" value="1" />
            </div>
          </div>

          <div class="btns">
            <button class="brand" id="scanBtn">ğŸ“· ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (Ø¨Ø§Ø±ÙƒÙˆØ¯)</button>
            <button class="ghost" id="torchBtn" type="button" title="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙ„Ø§Ø´" disabled>ğŸ”¦ ÙÙ„Ø§Ø´</button>

            <label class="switch" title="ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù">
              <input id="autoScan" type="checkbox" checked />
              <span>ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©</span>
            </label>
            <button id="addBtn">ï¼‹ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù</button>
            <button class="secondary" id="clearItemBtn">Ù…Ø³Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„ØµÙ†Ù</button>
          </div>

          <div class="msg" id="msg"></div>

          <div class="tbl-wrap"><table class="tbl" aria-label="items">
            <thead>
              <tr>
                <th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
                <th>Ø§Ù„Ø§Ø³Ù…</th>
                <th>Ø³Ø¹Ø±</th>
                <th>ÙƒÙ…ÙŠØ©</th>
                <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="itemsBody"></tbody>
          </table></div>

          <div class="totals">
            <div class="trow"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…</span><strong id="subTotal">0.00</strong></div>
            <div class="trow"><span>Ø®ØµÙ…</span><strong id="discount">0.00</strong></div>
            <div class="trow"><span>Ø¶Ø±ÙŠØ¨Ø©</span><strong id="tax">0.00</strong></div>
            <hr style="border:none;border-top:1px solid var(--border);margin:10px 0">
            <div class="trow"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span><strong id="grandTotal">0.00</strong></div>
            <div class="small">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù‡Ù†Ø§ Ù…Ø¨Ø¯Ø¦ÙŠØ©. Ù„Ùˆ Ø¹Ø§ÙŠØ² Ø±Ø¨Ø· ÙƒØ§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø´ÙŠØª (Ø­ÙØ¸/ØªØ±Ù‚ÙŠÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠ/Ø¬Ù„Ø¨ Ù…Ù† Products) Ù‡Ù†Ø±ÙƒÙ‘Ø¨Ù‡ Ø¨Ø¹Ø¯ Ù…Ø§ ØªØ«Ø¨Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©.</div>
          </div>

          <div class="btns" style="margin-top:12px">
            <button class="secondary" id="resetInvBtn">ØªÙØ±ÙŠØº Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
            <button class="brand" id="exportJsonBtn">ØªØµØ¯ÙŠØ± JSON</button>
          </div>
        </div>
        </div>
      </div>

      <div class="foot">Â© Axentro â€¢ All Rights Reserved 2024</div>
    </div>
  </div>

  <!-- Scanner modal -->
  <div class="modal" id="scanModal" aria-hidden="true">
    <div class="box">
      <div class="hd">
        <span>Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</span>
        <button class="secondary" id="closeScan">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="bd">
        <div class="scan-wrap">
        <div class="hint" style="margin-bottom:10px">Ù„Ùˆ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ø§ ØªØ¹Ù…Ù„: ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ³ØªØ®Ø¯Ù… <b>https</b> ÙˆØ³Ù…Ø­Øª Ø¨Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.</div>
        <video id="scanVideo" playsinline></video>
          <canvas id="scanCanvas" style="display:none;"></canvas>
          <div class="scan-target" aria-hidden="true"></div>
        </div>
        <div class="scan-hint">ÙˆØ¬Ù‘Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙˆØ³ÙŠØªÙ… Ø§Ù„ØªÙ‚Ø§Ø·Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</div>
      </div>
    </div>
  </div>

<script>
(() => {
  const cfg = (window.AXENTRO_CONFIG || {});
  const ok = !!(cfg.GAS_WEB_APP_URL && cfg.GOOGLE_CLIENT_ID);
  document.getElementById('cfg-state').textContent = ok ? 'OK' : 'MISSING';
  document.getElementById('cfg-pill').style.borderColor = ok ? '#16a34a55' : '#ef444455';
  document.getElementById('cfg-pill').style.background = ok ? '#16a34a10' : '#ef444410';
  document.getElementById('cfg-pill').style.color = ok ? '#14532d' : '#7f1d1d';

  // defaults
  const today = new Date();
  const pad = n => String(n).padStart(2,'0');
  document.getElementById('invDate').value = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
  document.getElementById('invNo').value = `PINV-${today.getFullYear()}${pad(today.getMonth()+1)}${pad(today.getDate())}-${pad(Math.floor(Math.random()*99)+1)}`;

  const msgEl = document.getElementById('msg');
  const showMsg = (type, text) => {
    msgEl.className = 'msg ' + (type || '');
    msgEl.textContent = text || '';
    msgEl.style.display = text ? 'block' : 'none';
  };

  /** Items state **/
  let items = []; // {barcode,name,cost,qty}

  const fmt = (n) => (Number(n||0)).toFixed(2);

  const recalc = () => {
    const sub = items.reduce((s,it)=>s + (Number(it.cost)||0)*(Number(it.qty)||0), 0);
    const disc = 0; // placeholder
    const tax = 0;  // placeholder
    document.getElementById('subTotal').textContent = fmt(sub);
    document.getElementById('discount').textContent = fmt(disc);
    document.getElementById('tax').textContent = fmt(tax);
    document.getElementById('grandTotal').textContent = fmt(sub - disc + tax);
  };

  const render = () => {
    const tb = document.getElementById('itemsBody');
    tb.innerHTML = '';
    for (let i=0;i<items.length;i++){
      const it = items[i];
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${it.barcode || ''}</td>
        <td>${escapeHtml(it.name || '')}</td>
        <td class="mono">${fmt(it.cost)}</td>
        <td class="mono">${Number(it.qty)||0}</td>
        <td class="mono">${fmt((Number(it.cost)||0)*(Number(it.qty)||0))}</td>
        <td><button class="danger" data-i="${i}" title="Ø­Ø°Ù">Ø­Ø°Ù</button></td>
      `;
      tb.appendChild(tr);
    }
    tb.querySelectorAll('button[data-i]').forEach(btn=>{
      btn.addEventListener('click', () => {
        const idx = Number(btn.getAttribute('data-i'));
        items.splice(idx,1);
        render(); recalc();
      });
    });
  };

  const genInternalBarcode = () => {
    // internal code, not real EAN. unique enough for inventory tracking
    const a = Date.now().toString(36).toUpperCase();
    const b = Math.random().toString(36).slice(2,6).toUpperCase();
    return `AX-${a}-${b}`;
  };

  const addItem = (barcode, name, cost, qty) => {
    barcode = (barcode||'').trim();
    name = (name||'').trim();
    cost = Number(cost||0);
    qty = Number(qty||0);

    if (!name && !barcode){
      showMsg('err','Ù„Ø§Ø²Ù… ØªØ¯Ø®Ù„ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬.');
      return false;
    }
    if (!name) name = '(Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…)';
    if (!barcode) barcode = genInternalBarcode();
    if (!(qty>0)) qty = 1;

    items.push({barcode, name, cost, qty});
    showMsg('ok', `ØªÙ… Ø¥Ø¶Ø§ÙØ©: ${name} â€¢ ${barcode}`);
    render(); recalc();
    return true;
  };

  // UI actions
  const $ = (id)=>document.getElementById(id);

  const clearItemFields = () => {
    $('barcode').value=''; $('name').value=''; $('cost').value=''; $('qty').value='1';
    showMsg('', '');
    $('barcode').focus();
  };

  

  let torchOn = false;

  const getVideoTrack = () => {
    const stream = window.__scanStream;
    if (!stream) return null;
    const [track] = stream.getVideoTracks();
    return track || null;
  };

  const updateTorchSupport = () => {
    const btn = $('torchBtn');
    if (!btn) return;
    const track = getVideoTrack();
    const caps = track?.getCapabilities?.();
    const ok = !!caps?.torch;
    btn.disabled = !ok;
    if (!ok) { torchOn = false; btn.textContent = 'ğŸ”¦ ÙÙ„Ø§Ø´'; }
  };

  const setTorch = async (on) => {
    const track = getVideoTrack();
    if (!track?.applyConstraints) return false;
    try{
      await track.applyConstraints({ advanced: [{ torch: !!on }] });
      torchOn = !!on;
      const btn = $('torchBtn');
      if (btn) btn.textContent = torchOn ? 'ğŸ”¦ ÙÙ„Ø§Ø´: ØªØ´ØºÙŠÙ„' : 'ğŸ”¦ ÙÙ„Ø§Ø´';
      return true;
    }catch(_e){
      return false;
    }
  };

$('addBtn').addEventListener('click', async () => {
    const added = addItem($('barcode').value, $('name').value, $('cost').value, $('qty').value);
    if (!added) return;
    clearItemFields();
    const auto = $('autoScan') ? $('autoScan').checked : true;
    if (auto) await startScanner();
  });

  $('clearItemBtn').addEventListener('click', () => {
    clearItemFields();
  });

  $('clearListBtn').addEventListener('click', () => {
    items = [];
    showMsg('', '');
    render(); recalc();
  });

  $('resetInvBtn').addEventListener('click', () => {
    items = [];
    $('supplier').value=''; $('ref').value='';
    showMsg('', '');
    render(); recalc();
  });
      const [bc,nm,cs,qt]=parts;
      const added = addItem(bc||'', nm||'', cs||0, qt||1);
      if (added) okCount++; else badCount++;
    });
    showMsg(okCount? 'ok':'err', `Ø§Ø³ØªÙŠØ±Ø§Ø¯: ${okCount} ØµÙ†Ù${badCount? ' â€¢ ÙØ´Ù„: '+badCount:''}`);
  });

  $('exportJsonBtn').addEventListener('click', async () => {
    const payload = {
      invoice: {
        no: $('invNo').value.trim(),
        date: $('invDate').value,
        supplier: $('supplier').value.trim(),
        ref: $('ref').value.trim(),
      },
      items: items.slice(),
      totals: {
        subTotal: Number($('subTotal').textContent)||0,
        grandTotal: Number($('grandTotal').textContent)||0
      }
    };
    await navigator.clipboard?.writeText(JSON.stringify(payload, null, 2)).catch(()=>{});
    showMsg('ok', 'ØªÙ… Ù†Ø³Ø® JSON Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø© (Clipboard).');
  });

  // Enter key adds item
  ['barcode','name','cost','qty'].forEach(id=>{
    $(id).addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){
        e.preventDefault();
        $('addBtn').click();
      }
    });
  });

  // Scanner (BarcodeDetector API - no external libs)
  const modal = $('scanModal');
  const openModal = () => { modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); };
  const closeModal = () => { modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); };

  let scanStream = null;
  let scanning = false;
  let detector = null;

  async function stopScanner(){
    scanning = false;
    try{
      const v = $('scanVideo');
      if (v) v.pause();
    try{ await setTorch(false); }catch(_e){}
    window.__scanStream = null;
    }catch(_){}
    if (scanStream){
      try{ scanStream.getTracks().forEach(t=>t.stop()); }catch(_){}
      scanStream = null;
    }
  }

  async async function startScanner(){
    // Reliable scanning: center-crop + stable reads + strict numeric validation
    if (!('mediaDevices' in navigator) || !navigator.mediaDevices.getUserMedia){
      showMsg('err','Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. Ø¬Ø±Ù‘Ø¨ Ù…ØªØµÙØ­ Chrome.');
      return;
    }
    if (!('BarcodeDetector' in window)){
      showMsg('err','Ù…ÙŠØ²Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­. Ø¬Ø±Ù‘Ø¨ Chrome Ù…ÙØ­Ø¯Ù‘ÙØ«.');
      return;
    }

    const formats = ['ean_13','ean_8','upc_a','upc_e','itf','code_128'];
    if (!detector){
      try{ detector = new BarcodeDetector({ formats }); }
      catch(_){ detector = new BarcodeDetector(); }
    }

    openModal();
    await stopScanner();

    const isValidBarcode = (value, formatHint) => {
      const v = String(value || '').replace(/[^\d]/g,'').trim(); // numeric-only
      if (!v) return null;

      // Prefer standard product barcode lengths; reject noisy short reads
      const len = v.length;
      if (formatHint === 'ean_13' && len !== 13) return null;
      if (formatHint === 'ean_8'  && len !== 8)  return null;
      if (formatHint === 'upc_a'  && len !== 12) return null;
      // upc_e can be 6 or 8 depending on representation
      if (formatHint === 'upc_e'  && !(len === 6 || len === 8)) return null;
      if (formatHint === 'itf'    && (len < 6 || len > 14 || (len % 2) === 1)) return null;

      // Generic fallback
      if (len < 6 || len > 14) return null;
      return v;
    };

    try{
      const video = $('scanVideo');
      const canvas = $('scanCanvas');
      const ctx = canvas.getContext('2d', { willReadFrequently: true });

      scanStream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: 'environment' },
          width: { ideal: 1920 },
          height: { ideal: 1080 },
          // Hint to reduce blur/noise on mobile cameras
          focusMode: 'continuous',
          exposureMode: 'continuous'
        },
        audio: false
      });

      video.srcObject = scanStream;
      await video.play();

      scanning = true;

      let last = '';
      let stable = 0;
      let lastTick = 0;

      const tick = async (ts) => {
        if (!scanning) return;

        // Throttle detection (heavier on CPU/camera). ~5 fps is enough.
        if (ts - lastTick < 180){
          requestAnimationFrame(tick);
          return;
        }
        lastTick = ts;

        try{
          const vw = video.videoWidth || 0;
          const vh = video.videoHeight || 0;
          if (!vw || !vh){
            requestAnimationFrame(tick);
            return;
          }

          // Center crop (reduces false positives from background numbers).
          const cropW = Math.floor(vw * 0.78);
          const cropH = Math.floor(vh * 0.35);
          const sx = Math.floor((vw - cropW) / 2);
          const sy = Math.floor((vh - cropH) / 2);

          canvas.width = cropW;
          canvas.height = cropH;
          ctx.drawImage(video, sx, sy, cropW, cropH, 0, 0, cropW, cropH);

          const codes = await detector.detect(canvas);
          if (codes && codes.length){
            // Prefer the most "prominent" code (largest area if available)
            const best = codes
              .map(c => {
                const pts = c.cornerPoints || [];
                let area = 0;
                if (pts.length >= 4){
                  const xs = pts.map(p=>p.x), ys = pts.map(p=>p.y);
                  area = (Math.max(...xs)-Math.min(...xs)) * (Math.max(...ys)-Math.min(...ys));
                }
                return { c, area };
              })
              .sort((a,b)=>b.area-a.area)[0].c;

            const cleaned = isValidBarcode(best.rawValue, best.format);
            if (cleaned){
              if (cleaned === last) stable += 1;
              else { last = cleaned; stable = 1; }

              // Require same value multiple times to avoid noisy reads
              if (stable >= 3){
                $('barcode').value = cleaned;
                await stopScanner();
                closeModal();
                $('name').focus();
                showMsg('ok','ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ø¯Ù‚Ø©. Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø³Ø¹Ø± Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø¶Ø§ÙØ©.');
                return;
              }
            }else{
              last = ''; stable = 0;
            }
          }else{
            last = ''; stable = 0;
          }
        }catch(_){
          // ignore and keep scanning
        }

        requestAnimationFrame(tick);
      };

      requestAnimationFrame(tick);

    }catch(_err){
      await stopScanner();
      closeModal();
      showMsg('err','ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. Ø§Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.');
    }
  }

  $('scanBtn').addEventListener('click', (e)=>{ e.preventDefault(); startScanner(); });
  $('closeScan').addEventListener('click', async (e)=>{ e.preventDefault(); closeModal(); await stopScanner(); });


  // helpers
  function escapeHtml(str){
    return String(str)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }
})();
</script>
</body>
</html>
