<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>( Sales Invoice ) ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª â€” B.S Medical &amp; Aesthetic</title>

  <style>
    :root{
      --bg:#f7f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --stroke:rgba(15,23,42,.10); --shadow:0 18px 50px rgba(2,6,23,.12);
      --radius:18px; --gold:#b08d57; --gold2:#d7b97a;
      --container-max:1100px;

      --ok:#16a34a; --okSoft: rgba(22,163,74,.10);
      --warn:#f59e0b; --warnSoft: rgba(245,158,11,.12);
      --bad:#dc2626; --badSoft: rgba(220,38,38,.10);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui,-apple-system,"Segoe UI",Tahoma,Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 10% 10%, rgba(176,141,87,.18), transparent 55%),
        radial-gradient(700px 500px at 90% 20%, rgba(215,185,122,.18), transparent 55%),
        linear-gradient(180deg, #fff, var(--bg));
      padding:18px;
      min-height:100vh;
      display:flex; flex-direction:column;
    }

    .wrap{max-width:var(--container-max); margin:0 auto; width:100%; flex:1}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 14px;
      border:1px solid var(--stroke);
      border-radius:18px;
      background:rgba(255,255,255,.88);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      flex-wrap:wrap;
      margin-bottom:16px;
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:220px;}
    .logo{
      width:44px;height:44px;border-radius:999px;display:grid;place-items:center;
      background: linear-gradient(135deg, rgba(176,141,87,.22), rgba(215,185,122,.18));
      border:1px solid rgba(176,141,87,.35);
      box-shadow: 0 10px 24px rgba(2,6,23,.10);
      overflow:hidden; padding:6px; flex:0 0 auto;
    }
    .logo img{width:100%;height:100%;object-fit:contain;display:block}
    .brandTitle{font-weight:900}
    .brandSub{font-size:12px;color:var(--muted);margin-top:2px;font-weight:800}

    .card{
      background:rgba(255,255,255,.92);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin-bottom:16px;
    }
    h2{margin:0 0 10px;font-weight:900}
    label{font-size:12px;color:var(--muted);font-weight:800}
    input, select, textarea{
      width:100%;
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.14);
      background:#fff;
      color:var(--text);
      outline:none;
    }
    input::placeholder, textarea::placeholder{color:#94a3b8}

    /* ===== Lookup suggest (Search + Barcode in one field) ===== */
    .lookupWrap{ position:relative; }
    .lookupRow{ display:flex; gap:8px; align-items:center; }
    .suggest{
      position:absolute;
      inset-inline:0;
      top: calc(100% + 8px);
      background: rgba(255,255,255,.98);
      border:1px solid rgba(15,23,42,.12);
      border-radius:14px;
      box-shadow: 0 18px 50px rgba(2,6,23,.14);
      max-height: 320px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      z-index: 50;
      padding:6px;
    }
    .suggestItem{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:1000;
      line-height:1.4;
      /* Ù…Ù‡Ù… Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
      touch-action: manipulation;
      user-select: none;
    }
    .suggestItem:hover{ background: rgba(176,141,87,.10); }
    .suggestItem.active{ background: rgba(176,141,87,.16); outline: 2px solid rgba(176,141,87,.22); }
    .suggestItem .meta{
      color: var(--muted);
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
      direction:ltr;
      unicode-bidi:embed;
    }
    .suggestEmpty{
      padding:10px 10px;
      color: var(--muted);
      font-weight:900;
      font-size:12px;
    }

    .row{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
    .row2{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
    .row1{display:grid; grid-template-columns:1fr; gap:10px}

    @media (max-width:920px){
      .row{grid-template-columns:repeat(2,1fr);}
      .row2{grid-template-columns:repeat(1,1fr);}
    }
    @media (max-width:520px){
      .row{grid-template-columns:repeat(1,1fr);}
      input, select, textarea{ font-size:16px; }
    }

    .table-wrap{overflow:auto;margin-top:10px;border-radius:12px}
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      min-width:980px;
      background:#fff;
      border-radius:12px;
      overflow:hidden;
    }
    th, td{
      border:1px solid rgba(15,23,42,.10);
      padding:8px;
      text-align:center;
      vertical-align:middle;
      white-space:nowrap;
    }
    th{
      background: linear-gradient(180deg, rgba(176,141,87,.10), rgba(215,185,122,.06));
      font-weight:900;
    }

    .btn{
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(176,141,87,.35);
      background:linear-gradient(135deg, rgba(176,141,87,.18), rgba(215,185,122,.14));
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      touch-action: manipulation;
    }
    .btn:hover{filter:brightness(1.02)}
    .btn.secondary{
      border-color: rgba(15,23,42,.14);
      background:#fff;
      opacity:.95;
    }
    .btn.danger{
      border-color: rgba(220,38,38,.22);
      background: rgba(220,38,38,.06);
      color:#991b1b;
    }

    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(15,23,42,.03);
      font-weight:1000;
      font-size:12px;
      line-height:1.7;
      display:none;
      word-break:break-word;
    }
    .msg.ok{border-color: rgba(22,163,74,.22); background: var(--okSoft); color:#14532d;}
    .msg.warn{border-color: rgba(245,158,11,.25); background: var(--warnSoft); color:#7c2d12;}
    .msg.bad{border-color: rgba(220,38,38,.22); background: var(--badSoft); color:#991b1b;}

    .totals{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .tline{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border:1px solid rgba(15,23,42,.10);
      border-radius:12px;
      background:#fff;
      font-weight:1000;
    }
    .tline .k{color:var(--muted);font-weight:900}
    .tline.primary{
      border-color: rgba(176,141,87,.35);
      background: linear-gradient(135deg, rgba(176,141,87,.10), rgba(215,185,122,.08));
    }

    .amountWords{
      margin-top:10px;
      font-weight:1000;
      color:#334155;
      border-top:1px dashed rgba(15,23,42,.14);
      padding-top:10px;
    }

    .site-footer{
      margin-top:auto;
      padding:16px 16px 18px;
      text-align:center;
      color:var(--muted);
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.78);
      backdrop-filter: blur(10px);
      border-radius:16px;
      width:min(520px, 94vw);
      margin-inline:auto;
      box-shadow: var(--shadow);
    }
    .site-footer .line1{ font-weight:1000; color:#0f172a; }
    .site-footer .line2{ margin-top:6px; font-weight:900; }

    .qrBox{ margin-top:14px; display:flex; justify-content:center; }
    .qrLink{ text-decoration:none; display:flex; flex-direction:column; align-items:center; gap:10px; }
    .qrLink img{
      width:132px; height:132px; max-width:60vw;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      padding:10px;
      box-shadow: 0 10px 26px rgba(2,6,23,.08);
      object-fit:contain;
      transition:transform .15s ease, box-shadow .15s ease;
    }
    .qrLink:hover img,.qrLink:active img{ transform:scale(1.03); box-shadow:0 14px 34px rgba(2,6,23,.12); }
    .qrText{ font-size:12px; font-weight:1000; color:#334155; }

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:22px;
      padding:12px 14px;
      background:#0f172a;
      color:#fff;
      border-radius:14px;
      font-weight:900;
      box-shadow:0 16px 40px rgba(2,6,23,.25);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index:9999;
      max-width:min(92vw, 520px);
      text-align:center;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-2px);
    }

    /* Responsive table on small screens */
    @media (max-width: 820px){
      .table-wrap{ overflow:visible; }
      table{ min-width:0; }
      table, thead, tbody, th, td, tr{ display:block; width:100%; }
      thead{ display:none; }
      tbody tr{
        border:1px solid rgba(15,23,42,.12);
        background: #fff;
        border-radius: 16px;
        padding:10px;
        margin-bottom:10px;
        box-shadow: 0 10px 28px rgba(2,6,23,.06);
      }
      tbody td{ border:none; padding:8px 0; text-align:right; white-space:normal; }
      tbody td + td{ border-top:1px dashed rgba(15,23,42,.12); }
      tbody td[data-label]::before{
        content: attr(data-label);
        display:block;
        font-size:12px;
        color: var(--muted);
        font-weight:900;
        margin-bottom:6px;
      }
      tbody input, tbody select{ width:100%; font-size:16px; text-align:center; font-weight:900; }
      tbody button{ width:100%; }
    }

    /* Scanner Modal */
    .modal{
      position:fixed; inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
      padding:14px;
      backdrop-filter: blur(10px);
    }
    .modal .modalCard{
      width:min(92vw, 720px);
      background:rgba(255,255,255,.92);
      border:1px solid rgba(15,23,42,.12);
      border-radius:18px;
      box-shadow:0 22px 60px rgba(2,6,23,.22);
      overflow:hidden;
    }
    .modalHeader{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.75);
    }
    .modalHeader strong{font-weight:1000}
    .modalBody{padding:12px}
    .videoWrap{
      width:100%;
      aspect-ratio: 16/9;
      background:#000;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(15,23,42,.12);
      position:relative;
    }
    video{width:100%;height:100%;object-fit:cover}
    .scanHint{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      line-height:1.6;
    }

    :focus{ outline:3px solid rgba(176,141,87,.22); outline-offset:3px; }
  </style>
</head>

<body>
<div class="toast" id="toast" role="status" aria-live="polite"></div>

<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="logo">
        <img src="assets/logo.png" alt="BS Logo" onerror="this.style.display='none'">
      </div>
      <div>
        <div class="brandTitle">B.S Medical &amp; Aesthetic</div>
        <div class="brandSub">( Sales Invoice ) ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª</div>
      </div>
    </div>

    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
      <a class="btn secondary" href="dashboard.html">â† Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯</a>
      <button class="btn danger" id="logoutBtn" type="button">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <div class="card">
    <h2>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h2>

    <div class="row" role="region" aria-label="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©">
      <div>
        <label for="invNo">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
        <input id="invNo" readonly />
      </div>
      <div>
        <label for="invDate">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
        <input id="invDate" type="date" />
      </div>
      <div>
        <label for="customerName">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
        <input id="customerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
      </div>
      <div>
        <label for="customerPhone">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
        <input id="customerPhone" placeholder="Ù…Ø«Ø§Ù„: 01xxxxxxxxx" inputmode="tel" />
      </div>
    </div>

    <div class="row2" style="margin-top:10px">
      <div>
        <label for="customerAddress">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
        <input id="customerAddress" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© / Ø§Ù„Ù…Ù†Ø·Ù‚Ø© / ØªÙØ§ØµÙŠÙ„)" />
      </div>
      <div>
        <label for="payMethod">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
        <select id="payMethod">
          <option value="CASH">ÙƒØ§Ø´</option>
          <option value="VISA">ÙÙŠØ²Ø§</option>
          <option value="INSTAPAY">Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ</option>
          <option value="WALLET">Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
        </select>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</h2>

    <div class="row">
      <div>
        <label for="barcode">Ø¨Ø§Ø±ÙƒÙˆØ¯ / Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù (ÙƒØªØ§Ø¨Ø© Ø£Ùˆ Ù…Ø³Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§)</label>

        <div class="lookupWrap">
          <div class="lookupRow">
            <input id="barcode" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù Ø£Ùˆ Ø§Ù…Ø³Ø­/Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯..." autocomplete="off" inputmode="search" />
            <button class="btn secondary" id="scanBtn" type="button">ğŸ“· Ù…Ø³Ø­</button>
          </div>

          <!-- Ù†ØªØ§Ø¦Ø¬ Ø¨Ø­Ø« Ù„Ø­Ø¸ÙŠ + Keyboard navigation (â†‘ â†“ Enter) -->
          <div id="lookupSuggest" class="suggest" role="listbox" aria-label="Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«" hidden></div>
        </div>
      </div>

      <div>
        <label for="qty">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
        <input id="qty" type="number" min="1" value="1" />
      </div>

      <div>
        <label for="unitPrice">Ø§Ù„Ø³Ø¹Ø±</label>
        <input id="unitPrice" type="number" step="0.01" min="0" value="" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¹Ø±" />
      </div>

      <div>
        <label for="productName">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label>
        <input id="productName" readonly placeholder="Ø³ÙŠØ¸Ù‡Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯" />
      </div>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
      <button class="btn" id="addItemBtn" type="button">ï¼‹ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
    </div>

    <div class="table-wrap">
      <table aria-label="Sales items">
        <thead>
          <tr>
            <th style="width:60px">#</th>
            <th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
            <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th>Ø§Ù„Ø³Ø¹Ø±</th>
            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
            <th>Ø­Ø°Ù</th>
          </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>
    </div>

    <div class="msg ok" id="msgOk"></div>
    <div class="msg warn" id="msgWarn"></div>
    <div class="msg bad" id="msgBad"></div>
  </div>

  <div class="card">
    <h2>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª</h2>

    <div class="row2">
      <div>
        <label for="discount">Ø®ØµÙ… (Ø¬Ù†ÙŠÙ‡)</label>
        <input id="discount" type="number" step="0.01" min="0" value="0" />
      </div>
      <div>
        <label for="shipping">Ø§Ù„Ø´Ø­Ù† / Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø¬Ù†ÙŠÙ‡)</label>
        <input id="shipping" type="number" step="0.01" min="0" value="0" />
      </div>
    </div>

    <div class="totals" id="totalsBox"></div>
    <div class="amountWords" id="amountWords"></div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
      <button class="btn" id="saveBtn" type="button">ğŸ’¾ Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
      <button class="btn danger" id="deleteBtn" type="button" style="display:none">ğŸ—‘ï¸ Ù†Ù‚Ù„ Ù„Ù„Ù…Ø­Ø°ÙˆÙØ§Øª</button>
      <button class="btn secondary" id="printA4Btn" type="button">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙˆØ­ÙØ¸ A4</button>
      <button class="btn secondary" id="thermal80Btn" type="button">ğŸ§¾ Ø·Ø¨Ø§Ø¹Ø© Ø­Ø±Ø§Ø±ÙŠ 80mm</button>
      <button class="btn secondary" id="thermal58Btn" type="button">ğŸ§¾ Ø·Ø¨Ø§Ø¹Ø© Ø­Ø±Ø§Ø±ÙŠ 58mm</button>
    </div>
  </div>

  <footer class="site-footer">
    <div class="line1">Axentro â€“ All Rights Reserved 2024 Â©</div>
    <div class="line2">By Ahmed Hamouda</div>

    <div class="qrBox">
      <a class="qrLink" href="https://axentro-official.github.io/axentro-website/links.html" target="_blank" rel="noopener">
        <img src="assets/qr.png" alt="QR Code">
        <span class="qrText">Scan me</span>
      </a>
    </div>
  </footer>
</div>

<!-- Scanner Modal -->
<div class="modal" id="scanModal" aria-hidden="true">
  <div class="modalCard" role="dialog" aria-modal="true" aria-label="Ù…Ø§Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯">
    <div class="modalHeader">
      <strong>ğŸ“· Ù…Ø§Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</strong>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
        <button class="btn secondary" id="torchBtn" type="button">ğŸ”¦ ÙÙ„Ø§Ø´</button>
        <button class="btn danger" id="closeScanBtn" type="button">âœ– Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
    <div class="modalBody">
      <div class="videoWrap">
        <video id="video" playsinline></video>
      </div>
      <div class="scanHint">
        ÙˆØ¬Ù‘Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯. Ø³ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„.
      </div>
    </div>
  </div>
</div>

<script src="config.js"></script>
<script src="app.js"></script>
<script>AxentroAuth.requireAuth();</script>

<script>
(function(){
  "use strict";

  const toastEl = document.getElementById('toast');
  function toast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(()=>toastEl.classList.remove('show'), 2200);
  }

  // ===== âœ… Scan Success Sound (assets/scan.mp3) - Volume 100% =====
  const _scanAudio = new Audio("assets/scan.mp3");
  _scanAudio.preload = "auto";
  _scanAudio.volume = 1;

  function primeScanAudio(){
    // ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø³Ø±ÙŠØ¹ Ø¯Ø§Ø®Ù„ Gesture Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ù€ Android/iOS)
    try{
      _scanAudio.volume = 1;
      _scanAudio.currentTime = 0;
      const p = _scanAudio.play();
      if(p && typeof p.then === "function"){
        p.then(()=>{
          _scanAudio.pause();
          _scanAudio.currentTime = 0;
        }).catch(()=>{});
      }else{
        _scanAudio.pause();
        _scanAudio.currentTime = 0;
      }
    }catch(e){
      // ignore
    }
  }

  function playScanSound(){
    try{
      _scanAudio.volume = 1;
      _scanAudio.pause();
      _scanAudio.currentTime = 0;
      const p = _scanAudio.play();
      if(p && typeof p.catch === "function") p.catch(()=>{});
    }catch(e){
      // ignore
    }
  }

  const elMsg = {
    ok: document.getElementById('msgOk'),
    warn: document.getElementById('msgWarn'),
    bad: document.getElementById('msgBad'),
  };
  function showMsg(type, text){
    elMsg.ok.style.display = "none";
    elMsg.warn.style.display = "none";
    elMsg.bad.style.display = "none";
    if(!text) return;
    const box = type === "ok" ? elMsg.ok : (type === "warn" ? elMsg.warn : elMsg.bad);
    box.textContent = text;
    box.style.display = "block";
  }

  const logoutBtn = document.getElementById('logoutBtn');
  logoutBtn.addEventListener('click', (e)=>{ e.preventDefault(); AxentroAuth.logout(); });

  // ===== Products cache (by barcode) =====
  let productsByBarcode = new Map();
  let productsList = [];

  async function loadProducts() {
    try {
      const res = await AxentroApi.getProducts();
      if(res && res.ok && Array.isArray(res.products)) {
        // Normalize once (performance): keep a list for search + a map for exact barcode lookup
        productsList = res.products.map(p=>({
          barcode: String(p.barcode||""),
          name: String(p.name||""),
          price: Number(p.price||0),
          raw: p
        }));
        productsByBarcode = new Map(productsList.filter(p=>p.barcode).map(p=>[p.barcode, p]));
      }
    } catch(e) {
      // ignore
    }
  }

  function toNum(v) {
    const n = Number(v);
    return isNaN(n) ? 0 : n;
  }

  function esc(s){
    return String(s||'')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  // ===== Invoice date default =====
  (function setDefaultDate(){
    try{
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      document.getElementById('invDate').value = `${yyyy}-${mm}-${dd}`;
    }catch(e){}
  })();

  // ===== Amount to Arabic words =====
  function numberToArabicWords(number){
    number = Number(number) || 0;
    if(number === 0) return "0 Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ ÙÙ‚Ø· Ù„Ø§ ØºÙŠØ±";
    const ones = ["","ÙˆØ§Ø­Ø¯","Ø§Ø«Ù†Ø§Ù†","Ø«Ù„Ø§Ø«Ø©","Ø£Ø±Ø¨Ø¹Ø©","Ø®Ù…Ø³Ø©","Ø³ØªØ©","Ø³Ø¨Ø¹Ø©","Ø«Ù…Ø§Ù†ÙŠØ©","ØªØ³Ø¹Ø©","Ø¹Ø´Ø±Ø©","Ø£Ø­Ø¯ Ø¹Ø´Ø±","Ø§Ø«Ù†Ø§ Ø¹Ø´Ø±","Ø«Ù„Ø§Ø«Ø© Ø¹Ø´Ø±","Ø£Ø±Ø¨Ø¹Ø© Ø¹Ø´Ø±","Ø®Ù…Ø³Ø© Ø¹Ø´Ø±","Ø³ØªØ© Ø¹Ø´Ø±","Ø³Ø¨Ø¹Ø© Ø¹Ø´Ø±","Ø«Ù…Ø§Ù†ÙŠØ© Ø¹Ø´Ø±","ØªØ³Ø¹Ø© Ø¹Ø´Ø±"];
    const tens = ["","Ø¹Ø´Ø±Ø©","Ø¹Ø´Ø±ÙˆÙ†","Ø«Ù„Ø§Ø«ÙˆÙ†","Ø£Ø±Ø¨Ø¹ÙˆÙ†","Ø®Ù…Ø³ÙˆÙ†","Ø³ØªÙˆÙ†","Ø³Ø¨Ø¹ÙˆÙ†","Ø«Ù…Ø§Ù†ÙˆÙ†","ØªØ³Ø¹ÙˆÙ†"];
    const hundreds = ["","Ù…Ø§Ø¦Ø©","Ù…Ø§Ø¦ØªØ§Ù†","Ø«Ù„Ø§Ø«Ù…Ø§Ø¦Ø©","Ø£Ø±Ø¨Ø¹Ù…Ø§Ø¦Ø©","Ø®Ù…Ø³Ù…Ø§Ø¦Ø©","Ø³ØªÙ…Ø§Ø¦Ø©","Ø³Ø¨Ø¹Ù…Ø§Ø¦Ø©","Ø«Ù…Ø§Ù†Ù…Ø§Ø¦Ø©","ØªØ³Ø¹Ù…Ø§Ø¦Ø©"];
    function subThousand(n){
      n = Number(n); if(n===0) return "";
      let res=[]; const h=Math.floor(n/100); const rest=n%100;
      if(h) res.push(hundreds[h]);
      if(rest){
        if(rest<20) res.push(ones[rest]);
        else{
          const t=Math.floor(rest/10), o=rest%10;
          if(o) res.push(ones[o]+" Ùˆ "+tens[t]); else res.push(tens[t]);
        }
      }
      return res.join(" Ùˆ ");
    }
    let parts=[];
    const million=Math.floor(number/1000000);
    const thousand=Math.floor((number%1000000)/1000);
    const rest=number%1000;
    if(million){ if(million===1) parts.push("Ù…Ù„ÙŠÙˆÙ†"); else if(million===2) parts.push("Ù…Ù„ÙŠÙˆÙ†Ø§Ù†"); else parts.push(subThousand(million)+" Ù…Ù„ÙŠÙˆÙ†"); }
    if(thousand){ if(thousand===1) parts.push("Ø£Ù„Ù"); else if(thousand===2) parts.push("Ø£Ù„ÙØ§Ù†"); else parts.push(subThousand(thousand)+" Ø£Ù„Ù"); }
    if(rest) parts.push(subThousand(rest));
    return `${parts.join(" Ùˆ ")} Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ ÙÙ‚Ø· Ù„Ø§ ØºÙŠØ±`;
  }

  // ===== Items state =====
  // ===== Edit mode (full page) =====
  const qp = new URLSearchParams(location.search || '');
  const PAGE_MODE = String(qp.get('mode') || 'create').toLowerCase();
  const EDIT_INVOICE_NO = String(qp.get('invoice') || '').trim();
  const IS_EDIT = (PAGE_MODE === 'edit' && !!EDIT_INVOICE_NO);

  let items = []; // {barcode, product_id, name, qty, unit_price}

  const barcodeInp = document.getElementById('barcode');
  const suggestBox = document.getElementById('lookupSuggest');

  let suggestItems = [];
  let suggestIndex = -1;
  let suggestTimer = null;

  // âœ… FIX: Ù…Ù†Ø¹ blur/input Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± ÙÙŠ Ø£ÙˆÙ„ Ø¶ØºØ·Ø© (Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„)
  let isPickingSuggestion = false;

  function normalize(s){ return String(s||"").trim().toLowerCase(); }

  function closeSuggest(){
    suggestItems = [];
    suggestIndex = -1;
    if(suggestBox){
      suggestBox.hidden = true;
      suggestBox.innerHTML = "";
    }
  }

  function selectSuggested(i){
    const p = suggestItems[i];
    if(!p) return;

    isPickingSuggestion = true;

    // Ø§Ù‚ÙÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ±Ù‹Ø§ (Ù‚Ø¨Ù„ Ø£ÙŠ blur) + Ø«Ø¨Øª Ø§Ù„Ù‚ÙŠÙ…Ø©
    closeSuggest();

    // Ø§Ù…Ø³Ø­ Ø§Ù„Ø£ÙˆÙ„ Ù„Ù…Ù†Ø¹ Ø¨Ø¹Ø¶ Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¯Ø®Ø§Ù„ query Ø§Ù„Ù‚Ø¯ÙŠÙ…
    barcodeInp.value = "";

    requestAnimationFrame(()=>{
      barcodeInp.value = p.barcode || p.name || "";

      fillProductNameByBarcode(); // will set name + price when barcode is present
      if((!productNameInp.value || productNameInp.value === "â€”") && p.name){
        productNameInp.value = p.name;
      }

      unitPriceInp.focus();
      try{ unitPriceInp.select(); }catch(e){}

      setTimeout(()=>{ isPickingSuggestion = false; }, 0);
    });
  }

  function renderSuggest(){
    if(!suggestBox) return;

    if(!suggestItems.length){
      suggestBox.innerHTML = '<div class="suggestEmpty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
      suggestBox.hidden = false;
      return;
    }

    suggestBox.hidden = false;
    suggestBox.innerHTML = suggestItems.map((p, i)=>{
      const name = esc(p.name);
      const bc = esc(p.barcode);
      return `<div class="suggestItem${i===suggestIndex? " active": ""}" role="option" aria-selected="${i===suggestIndex}" data-idx="${i}">
        <span>${name}</span>
        <span class="meta">${bc}</span>
      </div>`;
    }).join("");

    // âœ… FIX: Ø§Ø³ØªØ®Ø¯Ù… pointerdown/touchstart/mousedown Ø¨Ø¯Ù„ click (Ù‚Ø¨Ù„ blur)
    suggestBox.querySelectorAll('.suggestItem').forEach(node=>{
      const handler = (e)=>{
        e.preventDefault();
        e.stopPropagation();
        const i = Number(node.getAttribute('data-idx'));
        if(Number.isFinite(i)) selectSuggested(i);
      };

      node.addEventListener('pointerdown', handler, { passive:false });
      node.addEventListener('touchstart', handler, { passive:false });
      node.addEventListener('mousedown', handler, { passive:false });

      // fallback (Ù…Ø´ Ø£Ø³Ø§Ø³ÙŠ)
      node.addEventListener('click', (e)=>{
        e.preventDefault();
        e.stopPropagation();
        const i = Number(node.getAttribute('data-idx'));
        if(Number.isFinite(i)) selectSuggested(i);
      });
    });
  }

  function findByName(q){
    const nq = normalize(q);
    if(!nq) return null;
    // Exact name match first, then contains
    let hit = productsList.find(p => normalize(p.name) === nq);
    if(hit) return hit;
    hit = productsList.find(p => normalize(p.name).includes(nq));
    return hit || null;
  }

  function runSuggestSearch(){
    const q = normalize(barcodeInp.value);
    if(!q){
      closeSuggest();
      return;
    }

    // If it's a pure barcode and exact match exists -> auto fill fast
    const barcodeLike = /^[0-9]{3,}$/.test(q);
    if(barcodeLike){
      const exact = productsByBarcode.get(String(barcodeInp.value).trim());
      if(exact){
        closeSuggest();
        fillProductNameByBarcode();
        return;
      }
    }

    // Build suggestions (contains on name or barcode)
    const list = [];
    for(const p of productsList){
      if(list.length >= 12) break;
      const bc = normalize(p.barcode);
      const nm = normalize(p.name);
      if((bc && bc.includes(q)) || (nm && nm.includes(q))){
        list.push(p);
      }
    }

    suggestItems = list;
    suggestIndex = list.length ? 0 : -1;
    renderSuggest();
  }

  function debounceSuggest(){
    if(suggestTimer) clearTimeout(suggestTimer);
    // Debounce: ÙŠÙ‚Ù„Ù„ Ø¹Ø¯Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙÙ„ØªØ±Ø©/Ø§Ù„Ø±Ø³Ù… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ù…Ù‡Ù… Ù…Ø¹ 5000+ ØµÙ†Ù)
    suggestTimer = setTimeout(runSuggestSearch, 120);
  }

  const qtyInp = document.getElementById('qty');
  const unitPriceInp = document.getElementById('unitPrice');
  const productNameInp = document.getElementById('productName');

  function fillProductNameByBarcode() {
    const raw = String(barcodeInp.value||'').trim();
    if(!raw){
      productNameInp.value = '';
      return;
    }

    // 1) Exact barcode
    const p = productsByBarcode.get(raw);
    if(p){
      productNameInp.value = p.name || '';
      // Ø§Ù…Ù„Ø£ Ø§Ù„Ø³Ø¹Ø± Ù„Ùˆ ÙØ§Ø¶ÙŠ/ØµÙØ± ÙÙ‚Ø· (Ø¹Ù„Ø´Ø§Ù† Ù…Ø§ Ù†ÙƒØ³Ø±Ø´ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
      if(String(unitPriceInp.value||'').trim()==='' || Number(unitPriceInp.value||0)===0){
        unitPriceInp.value = Number(p.price||0) ? String(Number(p.price||0)) : '';
      }
      return;
    }

    // 2) Name lookup (Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ÙŠÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù)
    const byName = findByName(raw);
    if(byName){
      productNameInp.value = byName.name || '';
      if(String(unitPriceInp.value||'').trim()==='' || Number(unitPriceInp.value||0)===0){
        unitPriceInp.value = Number(byName.price||0) ? String(Number(byName.price||0)) : '';
      }
      return;
    }

    productNameInp.value = '';
  }

  // âœ… FIX: ØªØ¬Ø§Ù‡Ù„ input Ø£Ø«Ù†Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± suggestion
  barcodeInp.addEventListener('input', ()=>{
    if(isPickingSuggestion) return;
    fillProductNameByBarcode();
    debounceSuggest();
  });

  barcodeInp.addEventListener('change', ()=>{ fillProductNameByBarcode(); closeSuggest(); });

  // ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ±ÙƒÙŠØ² (Ù…ÙÙŠØ¯ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„)
  barcodeInp.addEventListener('focus', ()=>{ debounceSuggest(); });

  // âœ… FIX: blur Ù„Ø§ ÙŠÙ‚ÙÙ„ Ù„Ùˆ Ø¥Ø­Ù†Ø§ Ø¨Ù†Ø®ØªØ§Ø± suggestion
  barcodeInp.addEventListener('blur', ()=>{
    setTimeout(()=>{
      if(isPickingSuggestion) return;
      closeSuggest();
    }, 220);
  });

  // Keyboard navigation: â†‘ â†“ Enter + Escape
  barcodeInp.addEventListener('keydown', (e)=>{
    if(!suggestBox || suggestBox.hidden) return;

    if(e.key === 'ArrowDown'){
      e.preventDefault();
      if(!suggestItems.length) return;
      suggestIndex = Math.min(suggestItems.length - 1, suggestIndex + 1);
      renderSuggest();
      return;
    }
    if(e.key === 'ArrowUp'){
      e.preventDefault();
      if(!suggestItems.length) return;
      suggestIndex = Math.max(0, suggestIndex - 1);
      renderSuggest();
      return;
    }
    if(e.key === 'Enter'){
      // Ù„Ùˆ ÙÙŠ Suggestions Ù…ÙØªÙˆØ­Ø©ØŒ Enter ÙŠØ®ØªØ§Ø±
      if(suggestItems.length && suggestIndex >= 0){
        e.preventDefault();
        selectSuggested(suggestIndex);
      }
      return;
    }
    if(e.key === 'Escape'){
      closeSuggest();
      return;
    }
  });

  // Ø§Ù‚ÙÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¶ØºØ· Ø¨Ø±Ù‘Ù‡
  document.addEventListener('click', (ev)=>{
    if(!suggestBox || suggestBox.hidden) return;
    const inside = ev.target === barcodeInp || suggestBox.contains(ev.target);
    if(!inside) closeSuggest();
  }, true);

  const itemsBody = document.getElementById('itemsBody');

  function calcLineTotal(it){
    return (toNum(it.qty) * toNum(it.unit_price));
  }

  function render(){
    // table
    itemsBody.innerHTML = items.map((it, idx)=>{
      const lineTotal = calcLineTotal(it);
      return `
      <tr>
        <td data-label="#">${idx+1}</td>
        <td data-label="Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯">${esc(it.barcode||'')}</td>
        <td data-label="Ø§Ù„Ù…Ù†ØªØ¬">${esc(it.name||'')}</td>
        <td data-label="Ø§Ù„ÙƒÙ…ÙŠØ©">
          <input type="number" min="1" value="${esc(it.qty)}" data-idx="${idx}" data-field="qty">
        </td>
        <td data-label="Ø§Ù„Ø³Ø¹Ø±">
          <input type="number" step="0.01" min="0" value="${esc(it.unit_price)}" data-idx="${idx}" data-field="unit_price">
        </td>
        <td data-label="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ">${lineTotal.toFixed(2)} Ø¬Ù†ÙŠÙ‡</td>
        <td data-label="Ø­Ø°Ù">
          <button class="btn secondary" data-del="${idx}" type="button">âœ– Ø­Ø°Ù</button>
        </td>
      </tr>`;
    }).join('');

    // totals
    const totalBeforeDiscount = items.reduce((s,it)=> s + calcLineTotal(it), 0);
    const discount = Math.max(0, toNum(document.getElementById('discount').value));
    const afterDiscount = Math.max(0, totalBeforeDiscount - discount);
    const shipping = Math.max(0, toNum(document.getElementById('shipping').value));
    const finalTotal = afterDiscount + shipping;

    const shippingText = shipping > 0 ? `${shipping.toFixed(2)} Ø¬Ù†ÙŠÙ‡` : "ØªÙˆØµÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ";

    document.getElementById('totalsBox').innerHTML = `
      <div class="tline"><span class="k">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…</span><span>${totalBeforeDiscount.toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></div>
      <div class="tline"><span class="k">Ø§Ù„Ø®ØµÙ…</span><span>${discount.toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></div>
      <div class="tline"><span class="k">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¯ÙˆÙ† Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø­Ù† / Ø§Ù„ØªÙˆØµÙŠÙ„</span><span>${afterDiscount.toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></div>
      <div class="tline"><span class="k">Ø§Ù„Ø´Ø­Ù† / Ø§Ù„ØªÙˆØµÙŠÙ„</span><span>${shippingText}</span></div>
      <div class="tline primary"><span class="k">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span>${finalTotal.toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></div>
    `;

    document.getElementById('amountWords').textContent =
      `${numberToArabicWords(Math.round(finalTotal))}`;

    // bind delete + inputs
    itemsBody.querySelectorAll('[data-del]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const i = Number(btn.getAttribute('data-del'));
        items.splice(i,1);
        render();
      });
    });
    itemsBody.querySelectorAll('input[data-idx]').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const i = Number(inp.getAttribute('data-idx'));
        const field = inp.getAttribute('data-field');
        if(!items[i]) return;
        items[i][field] = inp.value;
        render();
      });
    });
  }

  document.getElementById('discount').addEventListener('input', render);
  document.getElementById('shipping').addEventListener('input', render);

  document.getElementById('addItemBtn').addEventListener('click', ()=>{
    const rawLookup = String(barcodeInp.value||'').trim(); // Ù†ÙØ³ Ø§Ù„Ø­Ù‚Ù„ (Ø¨Ø§Ø±ÙƒÙˆØ¯/Ø§Ø³Ù…)
    const qty = toNum(qtyInp.value);
    const unit_price = toNum(unitPriceInp.value);

    // 1) Ø­Ø§ÙˆÙ„ ÙƒÙ€ Barcode
    let p = productsByBarcode.get(rawLookup) || null;
    let barcode = rawLookup;

    // 2) Ù„Ùˆ Ù…Ø´ BarcodeØŒ Ø¬Ø±Ù‘Ø¨ ÙƒÙ€ Ø§Ø³Ù…
    if(!p){
      const byName = findByName(rawLookup);
      if(byName){
        p = byName;
        barcode = byName.barcode || rawLookup; // Ù†Ø«Ø¨Øª Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯
      }
    }

    if(!rawLookup) return toast('Ø§ÙƒØªØ¨/Ø§Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù Ø£ÙˆÙ„Ø§Ù‹');
    if(!p && !barcode) return toast('ØªØ¹Ø°Ø± Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙ†Ù');
    if(qty <= 0) return toast('Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
    if(unit_price < 0) return toast('Ø§Ù„Ø³Ø¹Ø± ØºÙŠØ± ØµØ­ÙŠØ­');

    items.push({
      barcode,
      product_id: p ? (p.raw && p.raw.product_id ? p.raw.product_id : (p.product_id || '')) : '',
      name: p ? (p.name||'') : (String(productNameInp.value||'') || ''),
      qty,
      unit_price
    });

    // clear add form
    barcodeInp.value = '';
    productNameInp.value = '';
    qtyInp.value = '1';
    unitPriceInp.value = '';
    closeSuggest();
    barcodeInp.focus();
    render();
  });

  // ===== Save to system =====
  document.getElementById('saveBtn').addEventListener('click', async ()=>{
    try{
      showMsg("warn", "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...");
      const payload = {
        invoice_no: document.getElementById('invNo').value,
        invoice_date: document.getElementById('invDate').value,
        customer_name: document.getElementById('customerName').value,
        customer_phone: document.getElementById('customerPhone').value,
        customer_address: document.getElementById('customerAddress').value,
        pay_method: document.getElementById('payMethod').value,
        discount: toNum(document.getElementById('discount').value),
        shipping: toNum(document.getElementById('shipping').value),
        items: items.map(it=>({
          barcode: it.barcode,
          product_id: it.product_id,
          name: it.name,
          qty: toNum(it.qty),
          unit_price: toNum(it.unit_price),
        }))
      };
      const out = IS_EDIT ? await AxentroApi.updateSaleInvoice(payload) : await AxentroApi.createSale(payload);
      if(out && out.ok){
        showMsg("ok", IS_EDIT ? "âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­" : "âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­");
      }else{
        showMsg("bad", (out && (out.error||out.message)) ? (out.error||out.message) : "ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸");
      }
    }catch(e){
      showMsg("bad", e && e.message ? e.message : String(e));
    }
  });

  // ===== Printing (A4 + Thermal) =====
  function escapeHtml(str){
    return String(str||"")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  }

  // ===== âœ… Invoice time 12H (HH:MM:SS AM/PM) =====
  function getNowTime12HMS(){
    const d = new Date();
    let hh = d.getHours();
    const ampm = hh >= 12 ? "PM" : "AM";
    hh = hh % 12;
    if(hh === 0) hh = 12;
    const mm = String(d.getMinutes()).padStart(2,'0');
    const ss = String(d.getSeconds()).padStart(2,'0');
    const hh2 = String(hh).padStart(2,'0');
    return `${hh2}:${mm}:${ss} ${ampm}`;
  }

  function getInvoiceData(){
    const invNo = document.getElementById('invNo').value || "";
    const invDate = document.getElementById('invDate').value || "";
    const invTime = getNowTime12HMS();

    const custName = document.getElementById('customerName').value || "";
    const custPhone = document.getElementById('customerPhone').value || "";
    const custAddress = document.getElementById('customerAddress').value || "";
    const payMethod = document.getElementById('payMethod').value || "";

    const discount = Math.max(0, toNum(document.getElementById('discount').value));
    const shipping = Math.max(0, toNum(document.getElementById('shipping').value));

    const itemsOut = items.map((it, idx)=>{
      const qty = toNum(it.qty);
      const price = toNum(it.unit_price);
      const total = qty * price;
      return { idx: idx+1, barcode: it.barcode, name: it.name, qty, price, total };
    });

    const totalBefore = itemsOut.reduce((s,i)=> s + i.total, 0);
    const afterDiscount = Math.max(0, totalBefore - discount);
    const finalTotal = afterDiscount + shipping;

    return {
      invNo, invDate, invTime,
      custName, custPhone, custAddress,
      payMethod,
      discount, shipping,
      items: itemsOut,
      totalBefore,
      afterDiscount,
      finalTotal,
      words: numberToArabicWords(Math.round(finalTotal))
    };
  }

  function openPrintWindow(html, title){
    const w = window.open("", "_blank");
    if(!w){ alert("Pop-up blocked. Ø§Ø³Ù…Ø­ Ø¨ÙØªØ­ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©."); return; }
    w.document.open(); w.document.write(html); w.document.close();
    try{ w.document.title = title || "ÙØ§ØªÙˆØ±Ø©"; }catch(e){}
    w.onload = function(){ w.focus(); setTimeout(()=> w.print(), 250); };
  }

  function buildA4Html(d){
    const shippingText = d.shipping > 0 ? `${d.shipping.toFixed(2)} Ø¬Ù†ÙŠÙ‡` : "ØªÙˆØµÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ";
    const itemsHtml = d.items.length ? d.items.map(it=>`
      <tr>
        <td>${it.idx}</td>
        <td>${escapeHtml(it.barcode)}</td>
        <td>${escapeHtml(it.name)}</td>
        <td>${it.qty}</td>
        <td>${it.price.toFixed(2)}</td>
        <td>${it.total.toFixed(2)}</td>
      </tr>
    `).join("") : `<tr><td colspan="6" style="padding:18px;text-align:center;color:#64748b">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù</td></tr>`;

    return `<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ÙØ§ØªÙˆØ±Ø© ${escapeHtml(d.invNo)}</title>
<style>
  :root{ --text:#0f172a; --muted:#64748b; --stroke: rgba(15,23,42,.10); }
  @page { size: A4; margin: 10mm; }
  body{font-family: Arial, Helvetica, sans-serif;color:var(--text);direction:rtl;margin:0;background:#fff;}
  .sheet{max-width:900px;margin:0 auto;}
  .card{background:#fff;border-radius:12px;padding:18px;margin-bottom:14px;border:1px solid var(--stroke);}
  .header{display:flex;justify-content:space-between;align-items:center;gap:12px;}
  .brand{display:flex;align-items:center;gap:12px}
  .brand img{width:64px;height:64px;object-fit:contain}
  h1{margin:0;font-weight:900}
  .meta{font-size:14px;color:var(--muted); line-height:1.7}
  .meta strong{color:#0f172a}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
  th,td{border:1px solid var(--stroke);padding:8px;text-align:center}
  th{background:#f7f7fb;}
  .totals{margin-top:12px;display:flex;flex-direction:column;gap:8px}
  .tline{display:flex;justify-content:space-between;gap:10px;border:1px solid var(--stroke);border-radius:10px;padding:10px 12px;background:#fff;font-weight:900}
  .tline span:first-child{color:#64748b;font-weight:900}
  .tline.primary{background:#f7f7fb;}
  .amountWords{margin-top:10px;font-weight:900;color:#334155}
  .custGrid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px}
  .custLine{border:1px dashed var(--stroke);border-radius:10px;padding:10px 12px}
  .qrWrap{margin-top:12px;display:flex;flex-direction:column;align-items:center;gap:8px}
  .qrWrap img{width:120px;height:120px;object-fit:contain;border:1px solid var(--stroke);border-radius:10px;padding:6px}
  .qrText{font-size:12px;color:#334155;font-weight:900}
  .footer{margin-top:10px;text-align:center;color:#64748b;font-size:12px;line-height:1.6}
</style>
</head>
<body>
<div class="sheet">
  <div class="card header">
    <div class="brand">
      <img src="assets/logo.png" onerror="this.style.display='none'">
      <div>
        <h1>B.S Medical &amp; Aesthetic</h1>
        <div class="meta">ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª: <strong>${escapeHtml(d.invNo)}</strong></div>
        <div class="meta">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: <strong>${escapeHtml(d.payMethod)}</strong></div>
      </div>
    </div>
    <div class="meta" style="text-align:left">
      <div>Ø§Ù„ØªØ§Ø±ÙŠØ®: <strong>${escapeHtml(d.invDate)}</strong></div>
      <div>Ø§Ù„ÙˆÙ‚Øª: <strong>${escapeHtml(d.invTime)}</strong></div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px;font-weight:900;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
    <div class="custGrid">
      <div class="custLine"><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${escapeHtml(d.custName)}</div>
      <div class="custLine"><strong>Ø§Ù„Ø±Ù‚Ù…:</strong> ${escapeHtml(d.custPhone)}</div>
      <div class="custLine"><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${escapeHtml(d.custAddress)}</div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px;font-weight:900;">Ø§Ù„Ø£ØµÙ†Ø§Ù</h3>
    <table>
      <thead>
        <tr><th>#</th><th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr>
      </thead>
      <tbody>${itemsHtml}</tbody>
    </table>

    <div class="totals">
      <div class="tline"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…</span><span>${Number(d.totalBefore||0).toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></div>
      <div class="tline"><span>Ø§Ù„Ø®ØµÙ…</span><span>${Number(d.discount||0).toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></div>
      <div class="tline"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¯ÙˆÙ† Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø­Ù† / Ø§Ù„ØªÙˆØµÙŠÙ„</span><span>${Number(d.afterDiscount||0).toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></div>
      <div class="tline"><span>Ø§Ù„Ø´Ø­Ù† / Ø§Ù„ØªÙˆØµÙŠÙ„</span><span>${shippingText}</span></div>
      <div class="tline primary"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span>${Number(d.finalTotal||0).toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></div>
    </div>

    <div class="amountWords">${escapeHtml(d.words)}</div>

    <div class="qrWrap">
      <img src="assets/qr.png" onerror="this.style.display='none'" alt="QR">
      <div class="qrText">Ø§Ù…Ø³Ø­ Ø§Ù„Ù€ QR Ù„Ù„ØªÙˆØ§ØµÙ„</div>
    </div>

    <div class="footer">Axentro â€“ All Rights Reserved 2024 Â©<br>By Ahmed Hamouda</div>
  </div>
</div>
</body>
</html>`;
  }

  function exportA4(){
    const d = getInvoiceData();
    openPrintWindow(buildA4Html(d), `ÙØ§ØªÙˆØ±Ø© ${d.invNo}`);
  }

  document.getElementById('printA4Btn').addEventListener('click', exportA4);

  // ===== Thermal printing =====
  function buildThermalHtml(mm, d){
    const widthMm = (mm === 58) ? 58 : 80;
    const shippingText = (Number(d.shipping||0) > 0) ? Number(d.shipping).toFixed(2) : "Ù…Ø¬Ø§Ù†ÙŠ";

    const itemsHtml = d.items.length ? d.items.map(it=>`
      <div class="item">
        <div class="name">${it.idx}) ${escapeHtml(it.name || it.barcode)}</div>
        <div class="meta">
          <span class="l">Qty: ${it.qty} Ã— ${it.price.toFixed(2)}</span>
          <span class="r">${it.total.toFixed(2)}</span>
        </div>
      </div>
      <div class="sep"></div>
    `).join("") : `<div class="m" style="text-align:center;margin:10px 0">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù</div>`;

    return `<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ÙØ§ØªÙˆØ±Ø© ${escapeHtml(d.invNo)}</title>
<style>
  @page { size: ${widthMm}mm auto; margin: 3mm; }
  html,body{ height:auto !important; }
  body{margin:0;font-family: Arial, Tahoma, sans-serif;color:#000;direction:rtl;background:#fff;}
  .paper{ width:${widthMm}mm; margin:0 auto; page-break-inside: avoid; break-inside: avoid; }
  .center{text-align:center; page-break-inside: avoid; break-inside: avoid;}
  .b{font-weight:900;font-size:13px;line-height:1.45}
  .m{font-weight:700;font-size:11px;line-height:1.55}
  .sep{border-top:1px dashed #000;margin:8px 0; page-break-inside: avoid; break-inside: avoid;}
  .totRow{display:flex;justify-content:space-between;gap:8px;font-weight:900;font-size:12px; page-break-inside: avoid; break-inside: avoid;}
  .totMain{font-size:14px}
  .foot{margin-top:8px;font-size:10px;color:#000;text-align:center;line-height:1.5; page-break-inside: avoid; break-inside: avoid;}
  .item{padding:6px 0; page-break-inside: avoid; break-inside: avoid;}
  .item .name{font-weight:900;font-size:12px;line-height:1.5}
  .item .meta{display:flex;justify-content:space-between;gap:8px;font-weight:700;font-size:11px;line-height:1.6;margin-top:2px}
  .item .meta .l,.item .meta .r{direction:ltr;text-align:left;unicode-bidi:embed}

  .logoWrap{display:flex;justify-content:center;margin-bottom:6px; page-break-inside: avoid; break-inside: avoid;}
  .logoWrap img{width:34px;height:34px;object-fit:contain}
  .qrWrap{display:flex;flex-direction:column;align-items:center;gap:6px;margin-top:10px; page-break-inside: avoid; break-inside: avoid;}
  .qrWrap img{width:90px;height:90px;object-fit:contain}
</style>
</head>
<body>
<div class="paper">
  <div class="center">
    <div class="logoWrap">
      <img src="assets/logo.png" onerror="this.style.display='none'" alt="Logo">
    </div>
    <div class="b">B.S Medical &amp; Aesthetic</div>
    <div class="m">ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª: <strong>${escapeHtml(d.invNo)}</strong></div>
    <div class="m">Ø§Ù„ØªØ§Ø±ÙŠØ®: <strong>${escapeHtml(d.invDate)}</strong></div>
    <div class="m">Ø§Ù„ÙˆÙ‚Øª: <strong>${escapeHtml(d.invTime)}</strong></div>
  </div>

  <div class="sep"></div>
  <div class="b">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
  <div class="m">Ø§Ù„Ø§Ø³Ù…: ${escapeHtml(d.custName)}</div>
  <div class="m">Ø§Ù„Ø±Ù‚Ù…: ${escapeHtml(d.custPhone)}</div>
  <div class="m">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${escapeHtml(d.custAddress)}</div>

  <div class="sep"></div>
  <div class="b">Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
  <div class="sep"></div>

  ${itemsHtml}

  <div class="totRow"><span>Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…</span><span>${Number(d.totalBefore||0).toFixed(2)}</span></div>
  <div class="totRow"><span>Ø§Ù„Ø®ØµÙ…</span><span>${Number(d.discount||0).toFixed(2)}</span></div>
  <div class="totRow"><span>Ø¨Ø¯ÙˆÙ† ØªÙˆØµÙŠÙ„</span><span>${Number(d.afterDiscount||0).toFixed(2)}</span></div>
  <div class="totRow"><span>Ø§Ù„ØªÙˆØµÙŠÙ„</span><span>${shippingText}</span></div>
  <div class="totRow totMain"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span>${Number(d.finalTotal||0).toFixed(2)}</span></div>

  <div class="sep"></div>
  <div class="m">${escapeHtml(d.words)}</div>

  <div class="qrWrap">
    <img src="assets/qr.png" onerror="this.style.display='none'" alt="QR">
    <div class="m">Scan me</div>
  </div>

  <div class="foot">Axentro â€“ All Rights Reserved 2024 Â©<br>By Ahmed Hamouda</div>
</div>
</body>
</html>`;
  }

  function printThermal(mm){
    const d = getInvoiceData();
    openPrintWindow(buildThermalHtml(mm, d), `ÙØ§ØªÙˆØ±Ø© ${d.invNo}`);
  }
  document.getElementById('thermal80Btn').addEventListener('click', ()=> printThermal(80));
  document.getElementById('thermal58Btn').addEventListener('click', ()=> printThermal(58));

  // ===== Invoice init (Create / Edit) =====
  (async function initInvoice(){
    try{
      // Role guardrails
      if(!window.AxentroRoles){ console.warn('AxentroRoles missing'); }
      const role = window.AxentroRoles ? window.AxentroRoles.axRole() : (localStorage.getItem('ax_role')||'viewer');
      const canCreate = window.AxentroRoles ? window.AxentroRoles.axCanCreate() : (role==='admin' || role==='sales');
      const canEdit = window.AxentroRoles ? window.AxentroRoles.axCanEdit() : (role==='admin');

      if(!canCreate){
        alert('ØºÙŠØ± Ù…ØµØ±Ø­: Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ± ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·');
        window.location.href = 'dashboard.html';
        return;
      }

      const readOnly = IS_EDIT && !canEdit;
      if(readOnly){
        // Sales/Viewer can open invoice for viewing only, not editing
        const saveBtn = document.getElementById('saveBtn');
        if(saveBtn) saveBtn.style.display = 'none';
        const addItemBtn = document.getElementById('addItemBtn');
        if(addItemBtn) addItemBtn.style.display = 'none';
        // Keep printing enabled
        const pA4 = document.getElementById('printA4Btn');
        if(pA4) pA4.dataset.allowReadonly = '1';
        const t80 = document.getElementById('thermal80Btn');
        if(t80) t80.dataset.allowReadonly = '1';
        const t58 = document.getElementById('thermal58Btn');
        if(t58) t58.dataset.allowReadonly = '1';

        if(window.AxentroRoles) window.AxentroRoles.axSetReadOnly(document.body);
      }

      const el = document.getElementById('invNo');
      if(IS_EDIT){
        el.value = EDIT_INVOICE_NO;
        document.getElementById('saveBtn').textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
        const delBtn = document.getElementById('deleteBtn');
        delBtn.style.display = '';

        // Load invoice + items
        const out = await AxentroApi.getSaleInvoice(EDIT_INVOICE_NO);
        const inv = out.invoice || {};
        const its = Array.isArray(out.items) ? out.items : [];

        // header fields
        document.getElementById('invDate').value = inv.invoice_date ? new Date(inv.invoice_date).toISOString().slice(0,10) : '';
        document.getElementById('customerName').value = inv.customer || '';
        document.getElementById('customerPhone').value = inv.customer_phone || '';
        document.getElementById('customerAddress').value = inv.customer_address || '';
        document.getElementById('payMethod').value = inv.payment_method || '';
        document.getElementById('discount').value = Number(inv.discount||0) || 0;
        document.getElementById('shipping').value = Number(inv.shipping||0) || 0;

        // items
        items = its.map(x=>({
          barcode: String(x.barcode||'').trim(),
          product_id: String(x.product_id||'').trim(),
          name: String(x.name||'').trim(),
          qty: Number(x.qty||0),
          unit_price: Number(x.unit_price||0)
        }));
        render();

        // Delete (soft)
        delBtn.addEventListener('click', async ()=>{
          if(!confirm('ØªØ£ÙƒÙŠØ¯ Ù†Ù‚Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ\n(Ø³ÙŠØªÙ… Ø¹ÙƒØ³ ØªØ£Ø«ÙŠØ±Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†)')) return;
          try{
            showMsg('warn','â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...');
            await AxentroApi.softDeleteSaleInvoice(EDIT_INVOICE_NO);
            showMsg('ok','âœ… ØªÙ… Ù†Ù‚Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª');
            setTimeout(()=> location.href = 'sales-log.html', 500);
          }catch(e){
            showMsg('bad', e && e.message ? e.message : String(e));
          }
        });
      }else{
        const fallback = 'SA001';
        if(!el.value) el.value = fallback;
      }
    }catch(e){
      console.warn(e);
    }
  })();

  // ===== Scanner (Barcode) =====
  const scanModal = document.getElementById('scanModal');
  const scanBtn = document.getElementById('scanBtn');
  const closeScanBtn = document.getElementById('closeScanBtn');
  const torchBtn = document.getElementById('torchBtn');
  const video = document.getElementById('video');

  let stream = null;
  let track = null;
  let torchOn = false;
  let rafId = null;

  function showModal(){
    scanModal.style.display = "flex";
    scanModal.setAttribute("aria-hidden","false");
  }
  function hideModal(){
    scanModal.style.display = "none";
    scanModal.setAttribute("aria-hidden","true");
  }

  async function stopCamera(){
    try{
      if(rafId) cancelAnimationFrame(rafId);
      rafId = null;
    }catch(e){}
    try{
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
      }
    }catch(e){}
    stream = null;
    track = null;
    torchOn = false;
    try{ torchBtn.textContent = "ğŸ”¦ ÙÙ„Ø§Ø´"; }catch(e){}
  }

  async function startCamera(){
    await stopCamera();
    const constraints = {
      audio:false,
      video:{
        facingMode: { ideal: "environment" },
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }
    };

    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    await video.play();

    track = stream.getVideoTracks()[0] || null;

    if("BarcodeDetector" in window){
      const detector = new BarcodeDetector({formats:["ean_13","ean_8","code_128","code_39","qr_code","upc_a","upc_e"]});
      const tick = async ()=>{
        try{
          const codes = await detector.detect(video);
          if(codes && codes.length){
            const raw = codes[0].rawValue || "";
            if(raw){
              barcodeInp.value = raw;
              fillProductNameByBarcode();
              closeSuggest();

              // âœ… ØµÙˆØª Ø¹Ù†Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø§Ø³ÙƒØ§Ù†
              playScanSound();

              toast("âœ… ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ÙƒÙˆØ¯");
              await stopCamera();
              hideModal();
              unitPriceInp.focus();
              return;
            }
          }
        }catch(e){}
        rafId = requestAnimationFrame(tick);
      };
      rafId = requestAnimationFrame(tick);
    }else{
      toast("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… BarcodeDetector. Ø§Ø³ØªØ®Ø¯Ù… Chrome Ø­Ø¯ÙŠØ«.");
    }
  }

  scanBtn.addEventListener('click', async ()=>{
    try{
      // âœ… Ù…Ù‡Ù…: ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØµÙˆØª Ø¯Ø§Ø®Ù„ Gesture Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      primeScanAudio();

      showModal();
      await startCamera();
    }catch(e){
      hideModal();
      alert("ØªØ¹Ø°Ø± ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.");
    }
  });

  closeScanBtn.addEventListener('click', async ()=>{
    await stopCamera();
    hideModal();
  });

  torchBtn.addEventListener('click', async ()=>{
    try{
      if(!track) return;
      const caps = track.getCapabilities ? track.getCapabilities() : {};
      if(!caps.torch){
        toast("Ø§Ù„ÙÙ„Ø§Ø´ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²");
        return;
      }
      torchOn = !torchOn;
      await track.applyConstraints({ advanced: [{ torch: torchOn }] });
      torchBtn.textContent = torchOn ? "ğŸ”¦ Ø¥ÙŠÙ‚Ø§Ù" : "ğŸ”¦ ÙÙ„Ø§Ø´";
    }catch(e){
      toast("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙ„Ø§Ø´");
    }
  });

  // Boot
  (async function boot(){
    await loadProducts();
    render();
  })();

})();
</script>

</body>
</html>
