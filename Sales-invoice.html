<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª â€” Axentro Backoffice</title>
  <link rel="stylesheet" href="style.css">
  <style>
    :root{
      --bg:#f7f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --stroke:rgba(15,23,42,.10); --shadow:0 18px 50px rgba(2,6,23,.12);
      --radius:18px; --gold:#b08d57; --gold2:#d7b97a;
      --container-max:1100px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui,-apple-system,"Segoe UI",Tahoma,Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 10% 10%, rgba(176,141,87,.18), transparent 55%),
        radial-gradient(700px 500px at 90% 20%, rgba(215,185,122,.18), transparent 55%),
        linear-gradient(180deg, #ffffff, var(--bg));
      padding:18px; padding-bottom:calc(18px + env(safe-area-inset-bottom));
      min-height:100vh; display:flex; flex-direction:column;
    }
    .wrap{max-width:var(--container-max);margin:0 auto;width:100%;flex:1}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 14px;border:1px solid var(--stroke);
      border-radius:18px;background:rgba(255,255,255,.86);
      box-shadow:var(--shadow);backdrop-filter:blur(10px);
      flex-wrap:wrap;margin-bottom:16px;
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:220px;}
    .logo{
      width:44px;height:44px;border-radius:999px;display:grid;place-items:center;
      background: linear-gradient(135deg, rgba(176,141,87,.22), rgba(215,185,122,.18));
      border:1px solid rgba(176,141,87,.35);
      box-shadow: 0 10px 24px rgba(2,6,23,.10);
      overflow:hidden;padding:6px;flex:0 0 auto;
    }
    .logo img{width:100%;height:100%;object-fit:contain;display:block}
    .brandTitle{font-weight:900}
    .brandSub{font-size:12px;color:var(--muted);margin-top:2px}
    .topActions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .card{
      background:rgba(255,255,255,.92);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin-bottom:16px;
    }

    h2{margin:0 0 10px;font-weight:900}
    label{font-size:12px;color:var(--muted)}
    input, textarea, select{
      width:100%;
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.14);
      background:#fff;
      color:var(--text);
      outline:none;
    }
    input::placeholder, textarea::placeholder{color:#94a3b8}
    #invNo{ font-weight:900; }

    .row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .row2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .row1{display:grid;grid-template-columns:1fr;gap:10px}
    @media (max-width:920px){ .row{grid-template-columns:repeat(2,1fr);} .row2{grid-template-columns:1fr;} }
    @media (max-width:720px){ .topbar{flex-direction:column;align-items:stretch} .topActions{justify-content:stretch} .topActions a,.topActions button{width:100%} }
    @media (max-width:520px){ .row{grid-template-columns:1fr;} input,textarea,select{font-size:16px;} }

    .btn{
      padding:12px; border-radius:14px;
      border:1px solid rgba(176,141,87,.35);
      background:linear-gradient(135deg, rgba(176,141,87,.18), rgba(215,185,122,.14));
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      touch-action: manipulation;
    }
    .btn.secondary{border-color: rgba(15,23,42,.14); background:#fff; opacity:.95;}
    .btn.danger{border-color: rgba(220,38,38,.25); background:rgba(220,38,38,.06);}

    .table-wrap{overflow:auto;margin-top:10px;border-radius:12px}
    table{width:100%;border-collapse:collapse;font-size:13px;min-width:760px;background:#fff;border-radius:12px;overflow:hidden;}
    th,td{border:1px solid rgba(15,23,42,.10);padding:8px;text-align:center;vertical-align:middle;}
    th{background: linear-gradient(180deg, rgba(176,141,87,.10), rgba(215,185,122,.06));font-weight:900;}

    .prodCell{text-align:right; font-weight:900;}
    .muted{color:var(--muted); font-weight:800;}
    .totals{margin-top:10px; display:grid; gap:8px;}
    .tline{display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;border:1px solid rgba(15,23,42,.10);border-radius:12px;background:#fff;font-weight:900;}
    .tline.primary{border-color: rgba(176,141,87,.35);
      background: linear-gradient(135deg, rgba(176,141,87,.10), rgba(215,185,122,.08));}

    /* Scanner modal */
    .modalBack{
      position:fixed; inset:0; background:rgba(2,6,23,.55);
      display:none; align-items:center; justify-content:center;
      padding:16px; z-index:9999;
    }
    .modalBack.show{display:flex;}
    .modal{
      width:min(720px, 96vw);
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(15,23,42,.12);
      box-shadow:0 18px 50px rgba(2,6,23,.22);
      overflow:hidden;
    }
    .modalHead{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-bottom:1px solid rgba(15,23,42,.10);}
    .modalHead .title{font-weight:900}
    .modalBody{padding:12px 14px;}
    .videoWrap{position:relative; border-radius:16px; overflow:hidden; border:1px solid rgba(15,23,42,.10); background:#000;}
    video{width:100%; height:auto; display:block;}
    .scanFrame{
      position:absolute; inset:12%;
      border:2px solid rgba(176,141,87,.85);
      border-radius:18px;
      box-shadow:0 0 0 9999px rgba(0,0,0,.18) inset;
      pointer-events:none;
    }
    .toast{
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      background: rgba(15,23,42,.92); color: #fff;
      padding: 10px 12px; border-radius: 14px;
      box-shadow: 0 18px 50px rgba(2,6,23,.18);
      font-weight: 900; font-size: 13px;
      opacity: 0; pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 99999; max-width: min(520px, 92vw); text-align:center;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px);}
  </style>
</head>

<body>
<div class="wrap" id="app">
  <div class="topbar">
    <div class="brand">
      <div class="logo">
        <img src="images/bslogo.webp" alt="Logo" onerror="this.style.display='none'">
      </div>
      <div>
        <div class="brandTitle">Axentro Backoffice</div>
        <div class="brandSub">ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª â€” Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø± ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</div>
      </div>
    </div>

    <div class="topActions">
      <a class="btn secondary" href="dashboard.html" style="text-decoration:none;white-space:nowrap">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯</a>
      <button class="btn secondary" id="logoutBtn" type="button">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <div class="card">
    <h2>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h2>

    <div class="row">
      <div>
        <label for="invNo">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
        <input id="invNo" value="SA001" readonly />
      </div>
      <div>
        <label for="invDate">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
        <input id="invDate" type="date" value="2026-02-11" />
      </div>
      <div>
        <label for="paymentMethod">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
        <select id="paymentMethod">
          <option value="CASH">CASH</option>
          <option value="VISA">VISA</option>
          <option value="INSTAPAY">INSTAPAY</option>
          <option value="TRANSFER">TRANSFER</option>
        </select>
      </div>
      <div>
        <label for="customer">Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
        <input id="customer" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
      </div>
    </div>

    <div class="row2" style="margin-top:10px">
      <div>
        <label for="discount">Ø®ØµÙ… Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø¬Ù†ÙŠÙ‡)</label>
        <input id="discount" type="number" step="0.01" min="0" value="0" />
      </div>
      <div>
        <label for="tax">Ø¶Ø±ÙŠØ¨Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø¬Ù†ÙŠÙ‡)</label>
        <input id="tax" type="number" step="0.01" min="0" value="0" />
      </div>
    </div>

    <div class="row1" style="margin-top:10px">
      <div>
        <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
        <input id="notes" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" />
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</h2>

    <div class="row">
      <div>
        <label for="barcode">Barcode</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <input id="barcode" placeholder="Ø§Ù…Ø³Ø­ Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯" inputmode="numeric" />
          <button class="btn secondary" id="scanBtn" type="button" style="white-space:nowrap;">ğŸ“· Ù…Ø³Ø­</button>
        </div>
      </div>
      <div>
        <label for="qty">Qty</label>
        <input id="qty" type="number" step="1" min="1" value="1" />
      </div>
      <div>
        <label for="unitPrice">Unit Price</label>
        <input id="unitPrice" type="number" step="0.01" min="0" placeholder="0" />
      </div>
      <div>
        <label for="productName">Product</label>
        <input id="productName" readonly placeholder="Ø³ÙŠØ¸Ù‡Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯" />
      </div>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
      <button class="btn" id="addItemBtn" type="button">ï¼‹ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ØµÙ†Ø§Ù</button>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:60px">#</th>
            <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th style="width:120px">Barcode</th>
            <th style="width:100px">Qty</th>
            <th style="width:140px">Unit Price</th>
            <th style="width:160px">Line Total</th>
            <th style="width:110px">Ø­Ø°Ù</th>
          </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>
    </div>

    <div class="totals" id="totals"></div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
      <button class="btn" id="saveBtn" type="button">ğŸ’¾ Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
      <button class="btn secondary" id="resetBtn" type="button">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
    </div>
  </div>
</div>

<div class="modalBack" id="scanModal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Barcode Scanner">
    <div class="modalHead">
      <div class="title">ğŸ“· Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</div>
      <button class="btn secondary" id="closeScanBtn" type="button">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="modalBody">
      <div class="row2" style="margin-bottom:10px">
        <div>
          <label for="cameraSelect">Camera</label>
          <select id="cameraSelect"></select>
        </div>
        <div>
          <label>Ù…Ø³Ø§Ø¹Ø¯Ø©</label>
          <div class="muted" style="padding:10px 12px;border:1px solid rgba(15,23,42,.10);border-radius:12px;background:#fff;">
            Ø¶Ø¹ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø°Ù‡Ø¨ÙŠ.
          </div>
        </div>
      </div>

      <div class="videoWrap">
        <video id="video" playsinline></video>
        <div class="scanFrame"></div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
        <button class="btn secondary" id="torchBtn" type="button" style="display:none;">ğŸ”¦ Flash</button>
        <button class="btn secondary" id="manualFillBtn" type="button">Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script src="config.js"></script>
<script src="app.js"></script>
<script>AxentroAuth.requireAuth();</script>

<script>
(function(){
  const toastEl = document.getElementById('toast');
  function toast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(()=>toastEl.classList.remove('show'), 2200);
  }

  const logoutBtn = document.getElementById('logoutBtn');
  logoutBtn.addEventListener('click', (e)=>{ e.preventDefault(); AxentroAuth.logout(); });

  // ===== Products cache (by barcode) =====
  let productsByBarcode = new Map();

  async function loadProducts() {
    try {
      const res = await AxentroApi.getProducts();
      if(res && res.ok && Array.isArray(res.products)) {
        productsByBarcode = new Map(res.products.map(p=>[String(p.barcode), p]));
      }
    } catch(e) {
      // ignore
    }
  }

  function toNum(v) {
    const n = Number(v);
    return isNaN(n) ? 0 : n;
  }

  // ===== Items state =====
  let items = []; // {barcode, product_id, name, qty, unit_price}

  const barcodeInp = document.getElementById('barcode');
  const qtyInp = document.getElementById('qty');
  const unitPriceInp = document.getElementById('unitPrice');
  const productNameInp = document.getElementById('productName');

  function fillProductNameByBarcode() {
    const b = String(barcodeInp.value||'').trim();
    const p = productsByBarcode.get(b);
    productNameInp.value = p ? (p.name || '') : '';
  }

  barcodeInp.addEventListener('input', fillProductNameByBarcode);
  barcodeInp.addEventListener('change', fillProductNameByBarcode);

  function resetItemInputs() {
    barcodeInp.value = '';
    qtyInp.value = 1;
    unitPriceInp.value = '';
    productNameInp.value = '';
    barcodeInp.focus();
  }

  function escapeHtml(s){
    return String(s||'')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  function render() {
    const body = document.getElementById('itemsBody');
    body.innerHTML = '';
    let subtotal = 0;

    items.forEach((it, idx)=>{
      const lineTotal = toNum(it.qty) * toNum(it.unit_price);
      subtotal += lineTotal;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td class="prodCell">${escapeHtml(it.name || '')}<div class="muted" style="margin-top:4px">${escapeHtml(it.product_id || '')}</div></td>
        <td>${escapeHtml(it.barcode)}</td>
        <td>${toNum(it.qty)}</td>
        <td>${toNum(it.unit_price).toFixed(2)}</td>
        <td>${lineTotal.toFixed(2)}</td>
        <td><button class="btn danger" data-del="${idx}" type="button">Ø­Ø°Ù</button></td>
      `;
      body.appendChild(tr);
    });

    body.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const i = Number(btn.getAttribute('data-del'));
        items.splice(i,1);
        render();
      });
    });

    const discount = toNum(document.getElementById('discount').value);
    const tax = toNum(document.getElementById('tax').value);
    const total = subtotal - discount + tax;

    const totals = document.getElementById('totals');
    totals.innerHTML = `
      <div class="tline"><span class="muted">Subtotal</span><span>${subtotal.toFixed(2)} EGP</span></div>
      <div class="tline"><span class="muted">Discount</span><span>${discount.toFixed(2)} EGP</span></div>
      <div class="tline"><span class="muted">Tax</span><span>${tax.toFixed(2)} EGP</span></div>
      <div class="tline primary"><span>Total</span><span>${total.toFixed(2)} EGP</span></div>
    `;
  }

  document.getElementById('discount').addEventListener('input', render);
  document.getElementById('tax').addEventListener('input', render);

  document.getElementById('addItemBtn').addEventListener('click', ()=>{
    const barcode = String(barcodeInp.value||'').trim();
    const qty = toNum(qtyInp.value);
    const unit_price = toNum(unitPriceInp.value);

    if(!barcode) return toast('Ø§ÙƒØªØ¨/Ø§Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹');
    if(qty <= 0) return toast('Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
    if(unit_price < 0) return toast('Ø§Ù„Ø³Ø¹Ø± ØºÙŠØ± ØµØ­ÙŠØ­');

    const p = productsByBarcode.get(barcode);
    items.push({
      barcode,
      product_id: p ? p.product_id : '',
      name: p ? (p.name||'') : '',
      qty,
      unit_price
    });

    render();
    resetItemInputs();
  });

  document.getElementById('resetBtn').addEventListener('click', ()=>{
    items = [];
    document.getElementById('customer').value = '';
    document.getElementById('notes').value = '';
    document.getElementById('discount').value = 0;
    document.getElementById('tax').value = 0;
    render();
    resetItemInputs();
    toast('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·');
  });

  document.getElementById('saveBtn').addEventListener('click', async ()=>{
    if(items.length === 0) return toast('Ø£Ø¶Ù ØµÙ†Ù ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');

    const customer = String(document.getElementById('customer').value||'').trim();
    if(!customer) return toast('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„');

    const invoiceDate = document.getElementById('invDate').value; // yyyy-mm-dd
    const discount = toNum(document.getElementById('discount').value);
    const tax = toNum(document.getElementById('tax').value);
    const payment_method = document.getElementById('paymentMethod').value || '';
    const notes = String(document.getElementById('notes').value||'').trim();

    const payload = {
      customer,
      invoice_date: invoiceDate ? (invoiceDate + 'T00:00:00') : null,
      discount,
      tax,
      payment_method,
      notes,
      items: items.map(it=>({
        barcode: it.barcode,
        qty: it.qty,
        unit_price: it.unit_price
      }))
    };

    try {
      const res = await AxentroApi.createSale(payload);
      if(res && res.ok) {
        const no = res.sale_invoice_no || 'SA';
        document.getElementById('invNo').value = no;
        toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ… Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + no);
        items = [];
        render();
        resetItemInputs();
      } else {
        toast((res && (res.error || res.message)) ? (res.error || res.message) : 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸');
      }
    } catch(e) {
      toast(String(e && e.message ? e.message : e));
    }
  });

  // ===== Scanner =====
  const scanModal = document.getElementById('scanModal');
  const scanBtn = document.getElementById('scanBtn');
  const closeScanBtn = document.getElementById('closeScanBtn');
  const cameraSelect = document.getElementById('cameraSelect');
  const video = document.getElementById('video');
  const manualFillBtn = document.getElementById('manualFillBtn');
  const torchBtn = document.getElementById('torchBtn');

  let stream = null;
  let detector = null;
  let scanTimer = null;
  let track = null;

  function stopScan() {
    if(scanTimer) { clearInterval(scanTimer); scanTimer = null; }
    if(stream) {
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
    track = null;
    torchBtn.style.display = 'none';
    scanModal.classList.remove('show');
    scanModal.setAttribute('aria-hidden','true');
  }

  async function listCameras() {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d=>d.kind === 'videoinput');
    cameraSelect.innerHTML = '';
    cams.forEach((c, idx)=>{
      const opt = document.createElement('option');
      opt.value = c.deviceId;
      opt.textContent = c.label || ('Camera ' + (idx+1));
      cameraSelect.appendChild(opt);
    });
    return cams;
  }

  async function startStream(deviceId) {
    if(stream) {
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
    const constraints = {
      video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: 'environment' },
      audio: false
    };
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    await video.play();
    track = stream.getVideoTracks()[0] || null;

    try {
      const caps = track && track.getCapabilities ? track.getCapabilities() : null;
      torchBtn.style.display = (caps && caps.torch) ? 'inline-block' : 'none';
    } catch(e) {
      torchBtn.style.display = 'none';
    }
  }

  async function openScan() {
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      toast('Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­');
      return;
    }
    scanModal.classList.add('show');
    scanModal.setAttribute('aria-hidden','false');

    let cams = [];
    try { cams = await listCameras(); } catch(e) {}

    const preferred = cameraSelect.value || (cams.length ? cams[cams.length-1].deviceId : null);
    await startStream(preferred);

    if('BarcodeDetector' in window) {
      try {
        detector = new window.BarcodeDetector({ formats: ['ean_13','ean_8','code_128','qr_code','upc_a','upc_e','code_39','code_93','itf'] });
      } catch(e) { detector = null; }
    }

    scanTimer = setInterval(async ()=>{
      if(!detector) return;
      try {
        const barcodes = await detector.detect(video);
        if(barcodes && barcodes.length) {
          const raw = String(barcodes[0].rawValue || '').trim();
          if(raw) {
            barcodeInp.value = raw;
            fillProductNameByBarcode();
            stopScan();
            toast('ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯');
          }
        }
      } catch(e) {}
    }, 180);
  }

  scanBtn.addEventListener('click', openScan);
  closeScanBtn.addEventListener('click', stopScan);
  scanModal.addEventListener('click', (e)=>{ if(e.target === scanModal) stopScan(); });

  cameraSelect.addEventListener('change', async ()=>{
    try { await startStream(cameraSelect.value); } catch(e) { toast('ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§'); }
  });

  manualFillBtn.addEventListener('click', ()=>{
    stopScan();
    barcodeInp.focus();
  });

  torchBtn.addEventListener('click', async ()=>{
    if(!track) return;
    try {
      const settings = track.getSettings ? track.getSettings() : {};
      const torchOn = settings.torch === true;
      await track.applyConstraints({ advanced: [{ torch: !torchOn }] });
    } catch(e) {
      toast('Flash ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…');
    }
  });

  // init
  loadProducts().finally(()=>{ render(); resetItemInputs(); });
})();
</script>
</body>
</html>
