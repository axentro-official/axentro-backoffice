<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Axentro - ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª</title>

  <!-- Runtime config (same folder) -->
  <script src="./config.js"></script>
  <!-- Shared app logic (Auth + API helpers) -->
  <script src="./app.js"></script>

<style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:rgba(15,23,42,.12);
      --brand:#0ea5e9;
      --danger:#ef4444;
      --ok:#16a34a;
      --shadow:0 12px 30px rgba(2,6,23,.10);
      --radius:18px;
      --pad:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans Arabic","Noto Kufi Arabic","Cairo",sans-serif;
      background: radial-gradient(1000px 500px at 15% 5%, #fde68a22, transparent 60%),
                  radial-gradient(1000px 500px at 85% 10%, #38bdf822, transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:28px auto;padding:0 14px;}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px;
      overflow:hidden;
    }
    .top{
      display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      margin-bottom:16px;
    }
    .brand{
      display:flex;gap:10px;align-items:center;
    }
    .logo{
      width:44px;height:44px;border-radius:999px;
      display:grid;place-items:center;
      border:1px solid #f59e0b55;background:#fff7ed;
      font-weight:800;
    }
    h1{margin:0;font-size:24px;letter-spacing:.2px}
    .sub{color:var(--muted);margin-top:4px;font-size:13px}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border-radius:999px;border:1px solid var(--border);
      background:#fff;
      color:var(--muted);
      font-size:13px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .grid{display:grid;grid-template-columns:1fr;gap:14px;}
    .sec-title{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin:10px 0 10px;
      font-weight:800;
    }
    .hint{color:var(--muted);font-size:12px;line-height:1.6}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){ .row{grid-template-columns:1fr} }
    label{display:block;font-size:12px;color:var(--muted);margin:6px 2px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:86px;resize:vertical}
    input:focus, textarea:focus, select:focus{border-color:#38bdf8aa; box-shadow:0 0 0 4px #38bdf822}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{
      border:0;
      border-radius:14px;
      padding:11px 14px;
      font-weight:700;
      cursor:pointer;
      background:#0f172a;
      color:#fff;
    }
    button.secondary{background:#f1f5f9;color:#0f172a;border:1px solid var(--border)}
    button.brand{background:var(--brand)}
    button.danger{background:var(--danger)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .msg{
      margin:12px 0 0;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      display:none;
      font-size:13px;
      line-height:1.6;
      white-space:pre-line;
    }
    .msg.ok{display:block;border-color:#16a34a55;background:#16a34a10;color:#14532d}
    .msg.err{display:block;border-color:#ef444455;background:#ef444410;color:#7f1d1d}
    .tbl{
      width:100%;
      border-collapse:separate;
      border-spacing:0 10px;
      margin-top:8px;
    }
    .tbl th{
      text-align:right;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      padding:6px 8px;
    }
    .tbl td{
      background:#fff;
      border:1px solid var(--border);
      padding:10px 8px;
      font-size:13px;
    }
    .tbl tr td:first-child{border-radius:14px 0 0 14px}
    .tbl tr td:last-child{border-radius:0 14px 14px 0}
    .mono{font-family:var(--mono);direction:ltr;text-align:left}
    .totals{
      margin-top:12px;
      padding:14px;
      border:1px dashed var(--border);
      border-radius:14px;
      background:#fff;
    }
    .trow{display:flex;justify-content:space-between;gap:10px;margin:6px 0;align-items:center}
    .trow strong{font-size:14px}
    .trow .val{min-width:140px;text-align:left;direction:ltr;font-family:var(--mono)}
    .small{font-size:12px;color:var(--muted)}
    .foot{
      text-align:center;
      color:var(--muted);
      font-size:12px;
      margin-top:14px;
    }

  /* Scanner modal */
  .modal{
    position:fixed;inset:0;display:none;place-items:center;
    background:rgba(2,6,23,.60);
    padding:18px;
    z-index:9999;
  }
  .modal.open{display:grid}
  .modal .box{
    width:min(720px, 100%);
    background:#fff;
    border-radius:18px;
    border:1px solid var(--border);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .modal .hd{
    padding:12px 14px;
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    border-bottom:1px solid var(--border);
    font-weight:900;
    flex-wrap:wrap;
  }
  .modal .bd{padding:12px 14px}
  #scanVideo{
    width:100%;
    max-height:65vh;
    border-radius:12px;
    background:#000;
    display:block;
  }
  .scanWrap{
    position:relative;
    border-radius:12px;
    overflow:hidden;
    background:#000;
  }
  .scanOverlay{
    position:absolute;inset:0;
    pointer-events:none;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .scanOverlay .frame{
    width:min(420px, 78%);
    aspect-ratio: 3 / 2;
    border:2px solid rgba(255,255,255,.85);
    border-radius:14px;
    box-shadow:0 0 0 999px rgba(0,0,0,.20) inset;
  }
  .scan-hint{
    margin-top:10px;
    font-size:13px;
    color:#6b7280;
    text-align:center;
    line-height:1.6;
  }
  .scanControls{
    margin-top:10px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
  }
  .scanControls select{
    max-width: 320px;
  }
</style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="brand">
          <div class="logo">AX</div>
          <div>
            <h1>ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª</h1>
            <div class="sub">Purchase Invoice â€¢ Ø¥Ø¶Ø§ÙØ© Ø£ØµÙ†Ø§Ù ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø£Ùˆ Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</div>
          </div>
        </div>
        <div class="pill" id="cfg-pill">
          <span>Config:</span> <span class="mono" id="cfg-state">â€¦</span>
          <span style="opacity:.35">â€¢</span>
          <span>Account:</span> <span class="mono" id="user-state">â€¦</span>
        </div>
      </div>

      <div class="grid">
        <div>
          <div class="sec-title">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© <span class="hint">Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: Ø§Ù„Ù…ÙˆØ±Ø¯ + Ø§Ù„ØªØ§Ø±ÙŠØ®</span></div>
          <div class="row">
            <div>
              <label>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
              <input id="invNo" class="mono" readonly />
              <div class="small" style="margin-top:6px">Ø³ÙŠØªÙ… ØªØ±Ù‚ÙŠÙ… Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸ (Ù…Ø«Ø§Ù„: PU001).</div>
            </div>
            <div>
              <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
              <input id="invDate" type="date" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Ø§Ù„Ù…ÙˆØ±Ø¯</label>
              <input id="supplier" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯" />
            </div>
            <div>
              <label>Ù…Ù„Ø§Ø­Ø¸Ø©</label>
              <input id="ref" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© / Ù…Ø±Ø¬Ø¹" />
            </div>
          </div>

          <div style="height:8px"></div>

          <div class="sec-title">Ø§Ù„Ø£ØµÙ†Ø§Ù</div>

          <div class="row">
            <div>
              <label>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <input id="barcode" class="mono" placeholder="Scan / Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯" inputmode="numeric" />
            </div>
            <div>
              <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ù…Ø·Ù„ÙˆØ¨ Ù„Ùˆ Ø¨Ø¯ÙˆÙ† Ø¨Ø§Ø±ÙƒÙˆØ¯)</label>
              <input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</label>
              <input id="cost" type="number" step="0.01" placeholder="0.00" />
            </div>
            <div>
              <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
              <input id="qty" type="number" step="1" placeholder="1" value="1" />
            </div>
          </div>

          <div class="btns">
            <button class="brand" id="scanBtn">ğŸ“· ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (Ø¨Ø§Ø±ÙƒÙˆØ¯)</button>
            <button id="addBtn">ï¼‹ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ØµÙ†Ø§Ù</button>
          </div>

          <div class="msg" id="msg"></div>

          <table class="tbl" aria-label="items">
            <thead>
              <tr>
                <th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
                <th>Ø§Ù„Ø§Ø³Ù…</th>
                <th>Ø³Ø¹Ø±</th>
                <th>ÙƒÙ…ÙŠØ©</th>
                <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="itemsBody"></tbody>
          </table>

          <div class="totals">
            <div class="trow"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…</span><strong class="val" id="subTotal">0.00</strong></div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Ø®ØµÙ…</label>
                <input id="discountIn" type="number" step="0.01" value="0" />
              </div>
              <div>
                <label>Ø¶Ø±ÙŠØ¨Ø©</label>
                <input id="taxIn" type="number" step="0.01" value="0" />
              </div>
            </div>

            <hr style="border:none;border-top:1px solid var(--border);margin:12px 0">
            <div class="trow"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span><strong class="val" id="grandTotal">0.00</strong></div>
            <div class="small">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¹Ù†Ø¯ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (Ù„Ùˆ Ø£Ø¯Ø®Ù„Øª Ø§Ù„Ø§Ø³Ù… Ø¨Ø¯ÙˆÙ† Ø¨Ø§Ø±ÙƒÙˆØ¯).</div>
          </div>

          <div class="btns" style="margin-top:12px">
            <button class="secondary" id="resetInvBtn">ØªÙØ±ÙŠØº</button>
            <button class="brand" id="saveBtn">ğŸ’¾ Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
          </div>
        </div>
      </div>

      <div class="foot">Â© Axentro â€¢ All Rights Reserved 2024</div>
    </div>
  </div>

  <!-- Scanner modal -->
  <div class="modal" id="scanModal" aria-hidden="true">
    <div class="box">
      <div class="hd">
        <span>Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</span>
        <div class="btns" style="margin-top:0">
          <button class="secondary" id="closeScan">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
      <div class="bd">
        <div class="hint" style="margin-bottom:10px">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ­ØªØ§Ø¬ <b>HTTPS</b> + Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. Ø¹Ù„Ù‰ Ø§Ù„Ù„Ø§Ø¨ØªÙˆØ¨/Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø£ÙØ¶Ù„ ØªØ¬Ø±Ø¨Ø© Ø¹Ù„Ù‰ Chrome.</div>

        <div class="scanWrap">
          <video id="scanVideo" playsinline></video>
          <div class="scanOverlay"><div class="frame"></div></div>
        </div>

        <div class="scanControls">
          <div style="flex:1;min-width:220px">
            <label>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (Ù„Ùˆ Ù…ØªØ§Ø­)</label>
            <select id="cameraSelect"></select>
          </div>
          <div class="btns" style="margin-top:20px">
            <button class="secondary" id="restartScan">Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„</button>
          </div>
        </div>

        <div class="scan-hint">ÙˆØ¬Ù‘Ù‡ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø± ÙˆØ³ÙŠØªÙ… Ø§Ù„ØªÙ‚Ø§Ø·Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ===== Auth guard =====
  try{ window.AxentroAuth?.requireAuth?.(); }catch(_){}

  const cfg = (window.AXENTRO_CONFIG || {});
  const ok = !!(cfg.GAS_WEB_APP_URL && cfg.GOOGLE_CLIENT_ID);
  document.getElementById('cfg-state').textContent = ok ? 'OK' : 'MISSING';
  document.getElementById('cfg-pill').style.borderColor = ok ? '#16a34a55' : '#ef444455';
  document.getElementById('cfg-pill').style.background = ok ? '#16a34a10' : '#ef444410';
  document.getElementById('cfg-pill').style.color = ok ? '#14532d' : '#7f1d1d';

  const sess = window.AxentroAuth?.getSession?.();
  document.getElementById('user-state').textContent = sess?.email ? sess.email : 'â€”';

  // defaults
  const today = new Date();
  const pad = n => String(n).padStart(2,'0');
  document.getElementById('invDate').value = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
  document.getElementById('invNo').value = 'PU001';

  const msgEl = document.getElementById('msg');
  const showMsg = (type, text) => {
    msgEl.className = 'msg ' + (type || '');
    msgEl.textContent = text || '';
    msgEl.style.display = text ? 'block' : 'none';
  };

  // ===== âœ… Scan Success Sound (assets/scan.mp3) | Volume 100% =====
  let _scanAudio = null;

  function initScanSound(){
    try{
      if(!_scanAudio){
        _scanAudio = new Audio('assets/scan.mp3');
        _scanAudio.preload = 'auto';
        _scanAudio.volume = 1; // 100%
      }else{
        _scanAudio.volume = 1; // ensure 100%
      }
      // unlock attempt (some browsers require a gesture)
      const p = _scanAudio.play();
      if(p && typeof p.then === 'function'){
        p.then(()=>{
          try{ _scanAudio.pause(); _scanAudio.currentTime = 0; }catch(_){}
        }).catch(()=>{ /* ignore */ });
      }else{
        try{ _scanAudio.pause(); _scanAudio.currentTime = 0; }catch(_){}
      }
    }catch(_){}
  }

  function playScanSound(){
    try{
      if(!_scanAudio){
        _scanAudio = new Audio('assets/scan.mp3');
        _scanAudio.preload = 'auto';
      }
      _scanAudio.volume = 1; // 100%
      try{ _scanAudio.currentTime = 0; }catch(_){}
      const p = _scanAudio.play();
      if(p && typeof p.catch === 'function') p.catch(()=>{});
    }catch(_){}
  }

  /** Items state **/
  let items = []; // {barcode,name,cost,qty}

  const fmt = (n) => (Number(n||0)).toFixed(2);

  const recalc = () => {
    const sub = items.reduce((s,it)=>s + (Number(it.cost)||0)*(Number(it.qty)||0), 0);
    const disc = Number(document.getElementById('discountIn').value || 0);
    const tax  = Number(document.getElementById('taxIn').value || 0);

    document.getElementById('subTotal').textContent = fmt(sub);
    document.getElementById('grandTotal').textContent = fmt(sub - disc + tax);

    document.getElementById('saveBtn').disabled = !(items.length > 0);
  };

  const render = () => {
    const tb = document.getElementById('itemsBody');
    tb.innerHTML = '';
    for (let i=0;i<items.length;i++){
      const it = items[i];
      const bcLabel = it.barcode ? it.barcode : 'â€”';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${escapeHtml(bcLabel)}</td>
        <td>${escapeHtml(it.name || '')}</td>
        <td class="mono">${fmt(it.cost)}</td>
        <td class="mono">${Number(it.qty)||0}</td>
        <td class="mono">${fmt((Number(it.cost)||0)*(Number(it.qty)||0))}</td>
        <td><button class="danger" data-i="${i}" title="Ø­Ø°Ù">Ø­Ø°Ù</button></td>
      `;
      tb.appendChild(tr);
    }
    tb.querySelectorAll('button[data-i]').forEach(btn=>{
      btn.addEventListener('click', () => {
        const idx = Number(btn.getAttribute('data-i'));
        items.splice(idx,1);
        render(); recalc();
      });
    });
  };

  const clearItemFields = () => {
    document.getElementById('barcode').value = '';
    document.getElementById('name').value = '';
    document.getElementById('cost').value = '';
    document.getElementById('qty').value = '1';
    document.getElementById('barcode').focus();
  };

  const addItem = (barcode, name, cost, qty) => {
    barcode = (barcode||'').trim();
    name = (name||'').trim();
    cost = Number(cost||0);
    qty = Number(qty||0);

    if (!name && !barcode){
      showMsg('err','Ù„Ø§Ø²Ù… ØªØ¯Ø®Ù„ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬.');
      return false;
    }
    if (!name) name = '(Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…)';
    if (!(qty>0)) qty = 1;

    // NOTE: Ù„Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙØ§Ø¶ÙŠØŒ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù‡ÙŠÙˆÙ„Ø¯ Internal Barcode ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
    items.push({barcode, name, cost, qty});
    showMsg('ok', `ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©: ${name}${barcode ? ' â€¢ '+barcode : ''}`);
    render(); recalc();
    clearItemFields();
    return true;
  };

  const $ = (id)=>document.getElementById(id);

  $('addBtn').addEventListener('click', () => {
    addItem($('barcode').value, $('name').value, $('cost').value, $('qty').value);
  });

  // Enter key adds item
  ['barcode','name','cost','qty'].forEach(id=>{
    $(id).addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){
        e.preventDefault();
        $('addBtn').click();
      }
    });
  });

  $('resetInvBtn').addEventListener('click', () => {
    items = [];
    $('supplier').value='';
    $('ref').value='';
    $('discountIn').value='0';
    $('taxIn').value='0';
    showMsg('', '');
    render(); recalc();
    clearItemFields();
    $('invNo').value = 'PU001';
  });

  ['discountIn','taxIn'].forEach(id=>{
    $(id).addEventListener('input', recalc);
  });

  // ===== Save to system =====
  $('saveBtn').addEventListener('click', async () => {
    try{
      $('saveBtn').disabled = true;

      const supplier = $('supplier').value.trim();
      if(!supplier){
        showMsg('err','Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯.');
        $('saveBtn').disabled = false;
        return;
      }

      const invDate = $('invDate').value;
      if(!invDate){
        showMsg('err','Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©.');
        $('saveBtn').disabled = false;
        return;
      }

      const payload = {
        supplier,
        invoice_date: invDate,
        discount: Number($('discountIn').value || 0),
        tax: Number($('taxIn').value || 0),
        notes: $('ref').value.trim(),
        items: items.map(it => ({
          barcode: (it.barcode || '').trim(),     // may be empty -> server generates internal barcode
          name: (it.name || '').trim(),
          qty: Number(it.qty || 0),
          unit_cost: Number(it.cost || 0),
          category: 'General',
          unit: 'PCS'
        }))
      };

      const res = await window.AxentroApi.createPurchase(payload);
      const invNo = res.purchase_invoice_no || '';
      if(invNo) $('invNo').value = invNo;

      showMsg('ok', `ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…\nØ±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${invNo || 'â€”'}`);

      // Clear items only (keep supplier/date if you want)
      items = [];
      render(); recalc();
      clearItemFields();

    }catch(err){
      const details = (err && err.message) ? err.message : String(err || 'Unknown error');
      showMsg('err', 'ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© âŒ\n' + details);
      $('saveBtn').disabled = false;
    }
  });

  // init
  render(); recalc();
  clearItemFields();

  // ===== Scanner (BarcodeDetector + camera selection) =====
  const modal = $('scanModal');
  const openModal = () => { modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); };
  const closeModal = () => { modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); };

  let scanStream = null;
  let scanning = false;
  let detector = null;

  async function stopScanner(){
    scanning = false;
    try{
      const v = $('scanVideo');
      if (v) v.pause();
    }catch(_){}
    if (scanStream){
      try{ scanStream.getTracks().forEach(t=>t.stop()); }catch(_){}
      scanStream = null;
    }
  }

  async function listCameras_(){
    const sel = $('cameraSelect');
    sel.innerHTML = '';
    try{
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d => d.kind === 'videoinput');
      if(!cams.length){
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'Camera (default)';
        sel.appendChild(opt);
        return;
      }
      cams.forEach((c, idx) => {
        const opt = document.createElement('option');
        opt.value = c.deviceId || '';
        opt.textContent = c.label || ('Camera ' + (idx+1));
        sel.appendChild(opt);
      });
    }catch(_){
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'Camera (default)';
      sel.appendChild(opt);
    }
  }

  async function startScanner(deviceId){
    if (!('mediaDevices' in navigator) || !navigator.mediaDevices.getUserMedia){
      showMsg('err','Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. Ø¬Ø±Ù‘Ø¨ Ù…ØªØµÙØ­ Chrome.');
      return;
    }
    if (!('BarcodeDetector' in window)){
      showMsg('err','Ù…ÙŠØ²Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­. Ø¬Ø±Ù‘Ø¨ Chrome Ù…ÙØ­Ø¯Ù‘ÙØ«.');
      return;
    }

    if (!detector){
      try{
        detector = new BarcodeDetector({ formats: ['ean_13','ean_8','code_128','code_39','upc_a','upc_e','itf','qr_code'] });
      }catch(_){
        detector = new BarcodeDetector();
      }
    }

    openModal();
    await stopScanner();

    try{
      const video = $('scanVideo');
      const constraints = deviceId
        ? { video: { deviceId: { exact: deviceId }, width: { ideal: 1280 }, height: { ideal: 720 } }, audio:false }
        : { video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } }, audio:false };

      scanStream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = scanStream;
      await video.play();

      scanning = true;

      const tick = async () => {
        if (!scanning) return;
        try{
          const codes = await detector.detect(video);
          if (codes && codes.length){
            const value = (codes[0].rawValue || '').trim();
            if (value){
              $('barcode').value = value;

              // âœ… ØµÙˆØª Ù†Ø¬Ø§Ø­ Ø§Ù„Ø§Ø³ÙƒØ§Ù† (assets/scan.mp3) - 100%
              playScanSound();

              await stopScanner();
              closeModal();
              $('name').focus();
              showMsg('ok','ØªÙ…Øª Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ âœ… Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø³Ø¹Ø± Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ØµÙ†Ø§Ù.');
              return;
            }
          }
        }catch(_){}
        requestAnimationFrame(tick);
      };
      requestAnimationFrame(tick);

    }catch(_err){
      await stopScanner();
      closeModal();
      showMsg('err','ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. Ø§Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.');
    }
  }

  $('scanBtn').addEventListener('click', async (e)=>{
    e.preventDefault();

    // âœ… Ù…Ù‡Ù…: ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¯Ø§Ø®Ù„ gesture Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    initScanSound();

    await listCameras_();
    const deviceId = $('cameraSelect').value || '';
    startScanner(deviceId);
  });

  $('restartScan').addEventListener('click', async (e)=>{
    e.preventDefault();

    // âœ… Ù…Ù‡Ù…: ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¯Ø§Ø®Ù„ gesture Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    initScanSound();

    await listCameras_();
    const deviceId = $('cameraSelect').value || '';
    startScanner(deviceId);
  });

  $('closeScan').addEventListener('click', async (e)=>{
    e.preventDefault();
    closeModal();
    await stopScanner();
  });

  $('cameraSelect').addEventListener('change', ()=>{
    if(!modal.classList.contains('open')) return;
    const deviceId = $('cameraSelect').value || '';
    startScanner(deviceId);
  });

  // helpers
  function escapeHtml(str){
    return String(str)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }
})();
</script>
</body>
</html>
