<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª â€” Axentro Backoffice</title>
  <link rel="stylesheet" href="style.css">
  <style>
    :root{
      --bg:#f7f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --stroke:rgba(15,23,42,.10); --shadow:0 18px 50px rgba(2,6,23,.12);
      --radius:18px; --gold:#b08d57; --gold2:#d7b97a;
      --container-max:1100px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui,-apple-system,"Segoe UI",Tahoma,Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 10% 10%, rgba(176,141,87,.18), transparent 55%),
        radial-gradient(700px 500px at 90% 20%, rgba(215,185,122,.18), transparent 55%),
        linear-gradient(180deg, #ffffff, var(--bg));
      padding:18px; padding-bottom:calc(18px + env(safe-area-inset-bottom));
      min-height:100vh; display:flex; flex-direction:column;
    }
    .wrap{max-width:var(--container-max);margin:0 auto;width:100%;flex:1}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 14px;border:1px solid var(--stroke);
      border-radius:18px;background:rgba(255,255,255,.86);
      box-shadow:var(--shadow);backdrop-filter:blur(10px);
      flex-wrap:wrap;margin-bottom:16px;
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:220px;}
    .logo{
      width:44px;height:44px;border-radius:999px;display:grid;place-items:center;
      background: linear-gradient(135deg, rgba(176,141,87,.22), rgba(215,185,122,.18));
      border:1px solid rgba(176,141,87,.35);
      box-shadow: 0 10px 24px rgba(2,6,23,.10);
      overflow:hidden;padding:6px;flex:0 0 auto;
    }
    .logo img{width:100%;height:100%;object-fit:contain;display:block}
    .brandTitle{font-weight:900}
    .brandSub{font-size:12px;color:var(--muted);margin-top:2px}
    .topActions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .card{
      background:rgba(255,255,255,.92);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin-bottom:16px;
    }

    h2{margin:0 0 10px;font-weight:900}
    label{font-size:12px;color:var(--muted)}
    input, textarea, select{
      width:100%;
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      outline:none;
      box-shadow:0 8px 18px rgba(2,6,23,.06);
      font-size:14px;
    }
    @media (max-width:720px){ input,textarea,select{font-size:16px;} }

    input:focus, textarea:focus, select:focus{
      border-color: rgba(176,141,87,.55);
      box-shadow:0 10px 22px rgba(176,141,87,.18);
    }

    .row{display:grid; grid-template-columns: repeat(4, 1fr); gap:12px;}
    @media (max-width:980px){ .row{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width:560px){ .row{grid-template-columns: 1fr;} }

    .row2{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    @media (max-width:720px){ .row2{grid-template-columns: 1fr;} }

    .btn{
      border:1px solid rgba(15,23,42,.14);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(2,6,23,.06);
      touch-action: manipulation;
      white-space:nowrap;
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{
      background:linear-gradient(135deg, rgba(176,141,87,.10), rgba(215,185,122,.08));
      border-color: rgba(176,141,87,.30);
    }
    .btn.danger{
      background:rgba(220,38,38,.06);
      border-color:rgba(220,38,38,.22);
      color:#991b1b;
    }

    table{width:100%; border-collapse:collapse; margin-top:10px;}
    th,td{padding:10px; border-bottom:1px solid rgba(15,23,42,.08); text-align:right; font-weight:700;}
    th{background:rgba(2,6,23,.03); font-weight:900;}
    .prodCell{min-width:180px}
    .muted{color:var(--muted)}
    .totals{margin-top:10px; display:grid; gap:8px;}
    .tline{display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;border:1px solid rgba(15,23,42,.10);border-radius:12px;background:#fff;font-weight:900;}
    .tline.primary{border-color: rgba(176,141,87,.35);
      background: linear-gradient(135deg, rgba(176,141,87,.10), rgba(215,185,122,.08));}

    /* Scanner modal */
    .modalBack{
      position:fixed; inset:0; background:rgba(2,6,23,.55);
      display:none; align-items:center; justify-content:center;
      padding:16px; z-index:9999;
    }
    .modalBack.show{display:flex;}
    .modal{
      width:min(720px, 96vw);
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(15,23,42,.12);
      box-shadow:0 18px 50px rgba(2,6,23,.22);
      max-height: min(92vh, 860px);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 14px; border-bottom:1px solid rgba(15,23,42,.10);
      background:rgba(2,6,23,.02);
    }
    .modalHead .title{font-weight:900}
    .modalBody{padding:14px; overflow:auto; -webkit-overflow-scrolling: touch;}
    #video{
      width:100%;
      max-height: 54vh;
      object-fit:cover;
      border-radius:14px;
      background:#000;
    }
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:16px; z-index:10000;
      background:rgba(2,6,23,.92); color:#fff;
      padding:10px 12px; border-radius:12px;
      font-weight:800; max-width:min(92vw, 520px);
      display:none;
    }
    .toast.show{display:block}

    /* ===== Footer (Unified) ===== */
    .site-footer{
      margin-top:16px;
      padding:16px 16px 18px;
      text-align:center;
      color:var(--muted);
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.78);
      backdrop-filter: blur(10px);
      border-radius:16px;
      width:min(520px, 94vw);
      margin-inline:auto;
      box-shadow: var(--shadow);
    }
    .site-footer .line1{ font-weight:900; color:var(--text); }
    .site-footer .line2{ margin-top:6px; font-weight:800; }
    .qrBox{ margin-top:14px; display:flex; justify-content:center; }
    .qrLink{
      text-decoration:none;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      color:inherit;
    }
    .qrLink img{
      width:132px;height:132px;max-width:60vw;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      padding:10px;
      box-shadow: 0 10px 26px rgba(2,6,23,.08);
      object-fit:contain;
      transition:transform .15s ease, box-shadow .15s ease;
    }
    .qrLink:hover img, .qrLink:active img{
      transform:scale(1.03);
      box-shadow:0 14px 34px rgba(2,6,23,.12);
    }
    .qrText{ font-size:12px; font-weight:900; color:#334155; }

    /* ===== Print box ===== */
    .printBox{
      margin-top:14px;
      border:1px solid rgba(15,23,42,.10);
      border-radius:14px;
      padding:12px;
      background:rgba(255,255,255,.9);
    }
    .printTitle{font-weight:900;margin-bottom:10px}
    .printGrid{display:grid;gap:10px;grid-template-columns:1fr}
    @media (min-width:560px){ .printGrid{grid-template-columns:1fr 1fr} }

    /* ===== Print templates ===== */
    .printArea{ display:none; }
    .noPrint{ }

    @media print{
      body{ background:#fff !important; padding:0 !important; }
      .noPrint{ display:none !important; }
      .printArea{ display:block !important; }
    }

    .receipt{
      font-family: system-ui,-apple-system,"Segoe UI",Tahoma,Arial;
      color:#000;
      direction: rtl;
    }
    .receipt h3{ margin:0 0 8px; font-size:14px; }
    .receipt .rmeta{ font-size:12px; margin:0 0 10px; }
    .receipt .rmeta div{ margin:2px 0; }
    .receipt table{ width:100%; border-collapse:collapse; font-size:12px; }
    .receipt th, .receipt td{ padding:6px 0; border-bottom:1px dashed #bbb; }
    .receipt th{ text-align:right; font-weight:900; }
    .receipt td.num{ text-align:left; direction:ltr; }
    .receipt .rtotals{ margin-top:10px; font-size:12px; }
    .receipt .rtotals .line{ display:flex; justify-content:space-between; gap:10px; margin:4px 0; }
    .receipt .rtotals .line strong{ font-weight:900; }
    .receipt .rfooter{ margin-top:12px; text-align:center; font-size:11px; }

  </style>
</head>
<body>

<div class="wrap">
  <div class="topbar noPrint">
    <div class="brand">
      <div class="logo"><img src="assets/logo.png" alt="BS Logo"></div>
      <div>
        <div class="brandTitle">B.S Medical &amp; Aesthetic</div>
        <div class="brandSub">ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª</div>
      </div>
    </div>
    <div class="topActions">
      <button class="btn danger" id="logoutBtn" type="button">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <div class="card noPrint">
    <h2>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h2>

    <div class="row">
      <div>
        <label for="invNo">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø§Ù„Ù†Ø¸Ø§Ù…)</label>
        <div class="muted" style="margin-top:6px">ÙŠÙØ­ÙØ¸ ÙÙŠ Ø§Ù„Ø´ÙŠØª ÙƒÙ…Ø§ Ù‡Ùˆ (Ù…Ø«Ø§Ù„: SA001)</div>
        <input id="invNo" value="SA001" readonly />
      </div>
      <div>
        <label for="invDisplayNo">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø¹Ø±Ø¶/Ø·Ø¨Ø§Ø¹Ø©)</label>
        <input id="invDisplayNo" value="" readonly />
      </div>
      <div>
        <label for="invDate">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
        <input id="invDate" type="date" value="2026-02-11" />
      </div>
      <div>
        <label for="paymentMethod">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
        <select id="paymentMethod">
          <option value="CASH">ÙƒØ§Ø´</option>
          <option value="VISA">ÙÙŠØ²Ø§</option>
          <option value="INSTAPAY">Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ</option>
          <option value="TRANSFER">Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
        </select>
      </div>
      <div>
        <label for="customer">Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
        <input id="customer" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
      </div>

      <div>
        <label for="customerPhone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
        <input id="customerPhone" inputmode="tel" placeholder="01xxxxxxxxx" autocomplete="tel" />
      </div>
      <div>
        <label for="customerAddress">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
        <input id="customerAddress" placeholder="Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© / Ø§Ù„Ù…Ù†Ø·Ù‚Ø© / ØªÙØ§ØµÙŠÙ„" autocomplete="street-address" />
      </div>
    </div>

    <div class="row2" style="margin-top:10px">
      <div>
        <label for="discount">Ø§Ù„Ø®ØµÙ… (Ø¹Ù„Ù‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©)</label>
        <input id="discount" type="number" min="0" step="0.01" value="0" />
      </div>
      <div>
        <label for="tax">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</label>
        <input id="tax" type="number" min="0" step="0.01" value="0" />
      </div>
    </div>

    <div style="margin-top:10px">
      <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
      <textarea id="notes" rows="2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
    </div>
  </div>

  <div class="card noPrint">
    <h2>Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</h2>
    <div class="row2">
      <div>
        <label for="barcode">Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
        <input id="barcode" placeholder="Ø§Ù…Ø³Ø­/Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯" />
      </div>
      <div style="display:flex; gap:10px; align-items:end; flex-wrap:wrap">
        <button class="btn secondary" id="scanBtn" type="button">ğŸ“· Ù…Ø³Ø­</button>
        <button class="btn" id="addItemBtn" type="button">ï¼‹ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ØµÙ†Ø§Ù</button>
      </div>
    </div>

    <div class="row2" style="margin-top:10px">
      <div>
        <label for="qty">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
        <input id="qty" type="number" min="1" step="1" value="1" />
      </div>
      <div>
        <label for="unitPrice">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</label>
        <input id="unitPrice" type="number" min="0" step="0.01" value="0" />
      </div>
    </div>

    <div style="margin-top:10px">
      <label for="productName">Ø§Ù„Ù…Ù†ØªØ¬</label>
      <input id="productName" placeholder="Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯" readonly />
      <div class="muted" id="productSku" style="margin-top:6px"></div>
    </div>
  </div>

  <div class="card">
    <h2 class="noPrint">Ø§Ù„Ø£ØµÙ†Ø§Ù</h2>
    <div style="overflow:auto" class="noPrint">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø·Ø±</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>
    </div>

    <div class="totals noPrint" id="totals"></div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px" class="noPrint">
      <button class="btn" id="saveBtn" type="button">ğŸ’¾ Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
      <button class="btn secondary" id="resetBtn" type="button">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
    </div>

    <div class="printBox noPrint" aria-label="Print actions">
      <div class="printTitle">Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</div>
      <div class="printGrid">
        <button class="btn secondary" id="print80" type="button">ğŸ§¾ Ø·Ø¨Ø§Ø¹Ø© Ø­Ø±Ø§Ø±ÙŠ 80mm</button>
        <button class="btn secondary" id="print58" type="button">ğŸ§¾ Ø·Ø¨Ø§Ø¹Ø© Ø­Ø±Ø§Ø±ÙŠ 58mm</button>
        <button class="btn secondary" id="printA4" type="button">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© A4</button>
        <button class="btn secondary" id="pdfA4" type="button">ğŸ“„ Ø­ÙØ¸ PDF A4</button>
      </div>
      <div class="muted" style="margin-top:8px">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø­ÙØ¸ PDF ÙŠØªÙ… Ø¹Ø¨Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Ø§Ø®ØªÙØ± "Save as PDF").</div>
    </div>

    <div id="printArea" class="printArea" aria-hidden="true"></div>
  </div>
</div>

<div class="modalBack" id="scanModal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Ù…Ø§Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯">
    <div class="modalHead">
      <div class="title">ğŸ“· Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</div>
      <button class="btn secondary" id="closeScanBtn" type="button">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="modalBody">
      <div class="row2" style="margin-bottom:10px">
        <div>
          <label for="cameraSelect">Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</label>
          <select id="cameraSelect"></select>
        </div>
        <div>
          <label>Ù…Ø³Ø§Ø¹Ø¯Ø©</label>
          <div class="muted" style="padding:10px 12px;border:1px solid rgba(15,23,42,.10);border-radius:12px;background:#fff">
            Ù„Ùˆ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙÙŠÙ‡ Ø£ÙƒØªØ± Ù…Ù† ÙƒØ§Ù…ÙŠØ±Ø§ØŒ Ø§Ø®ØªØ± Ø§Ù„Ø®Ù„ÙÙŠØ©. Ù„Ùˆ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ø§ ØªØ¹Ù…Ù„ Ø¬Ø±Ù‘Ø¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.
          </div>
        </div>
      </div>

      <video id="video" playsinline muted></video>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
        <button class="btn secondary" id="torchBtn" type="button" style="display:none">ğŸ”¦ ÙÙ„Ø§Ø´</button>
        <button class="btn" id="manualFillBtn" type="button">Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ</button>
      </div>
    </div>
  </div>
</div>

<footer class="site-footer noPrint">
  <div class="line1">Axentro â€“ All Rights Reserved 2024 Â©</div>
  <div class="line2">By Ahmed Hamouda</div>
  <div class="qrBox">
    <a class="qrLink" href="https://axentro-official.github.io/axentro-website/links.html" target="_blank" rel="noopener">
      <img src="assets/qr.png" alt="QR Code">
      <span class="qrText">Scan me</span>
    </a>
  </div>
</footer>

<div class="toast" id="toast"></div>

<script src="config.js"></script>
<script src="app.js"></script>

<script>
(function(){
  "use strict";

  if (window.AxentroAuth && AxentroAuth.requireAuth) AxentroAuth.requireAuth();

  const toastEl = document.getElementById('toast');
  let toastTimer = null;
  function toast(msg){
    clearTimeout(toastTimer);
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    toastTimer = setTimeout(()=>toastEl.classList.remove('show'), 2400);
  }

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', ()=>{
    try { AxentroAuth.logout(); } catch(e) { location.href="login.html"; }
  });

  // State
  let products = [];
  let items = []; // {barcode, product_id, name, qty, unit_price}

  function toNum(v){
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  function escapeHtml(s){
    return String(s ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function buildDisplayInvoiceNo(baseNo, dateStr){
    const digits = String(baseNo||"").replace(/[^0-9]/g,"");
    const seq = digits ? digits.padStart(3,"0").slice(-3) : "001";
    const ds = String(dateStr||todayISO()).replace(/-/g,"");
    return `INV-BS-${ds}-${seq}`;
  }

  function paymentLabel(val){
    switch(String(val||"")){
      case "CASH": return "ÙƒØ§Ø´";
      case "VISA": return "ÙÙŠØ²Ø§";
      case "INSTAPAY": return "Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ";
      case "TRANSFER": return "Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©";
      default: return String(val||"");
    }
  }

  function updateInvoiceDisplay(){
    const invNoEl = document.getElementById("invNo");
    const invDateEl = document.getElementById("invDate");
    const dispEl = document.getElementById("invDisplayNo");
    if(!invNoEl || !invDateEl || !dispEl) return;
    const base = String(invNoEl.value||"").trim();
    const date = String(invDateEl.value||"").trim() || todayISO();
    dispEl.value = buildDisplayInvoiceNo(base, date);
  }

  function setPrintPageStyle(mode){
    let css = "";
    if(mode === "thermal80") css = "@page{size:80mm auto; margin:5mm;}";
    else if(mode === "thermal58") css = "@page{size:58mm auto; margin:4mm;}";
    else css = "@page{size:A4; margin:12mm;}";

    let st = document.getElementById("printPageStyle");
    if(!st){
      st = document.createElement("style");
      st.id = "printPageStyle";
      document.head.appendChild(st);
    }
    st.textContent = css;
  }

  function updatePrintArea(subtotal, discount, tax, total){
    const area = document.getElementById("printArea");
    if(!area) return;

    const invNo = String(document.getElementById("invNo").value||"").trim();
    const invDisp = String(document.getElementById("invDisplayNo").value||"").trim();
    const invDate = String(document.getElementById("invDate").value||"").trim();
    const customer = String(document.getElementById("customer").value||"").trim();
    const phone = String((document.getElementById("customerPhone")||{}).value||"").trim();
    const address = String((document.getElementById("customerAddress")||{}).value||"").trim();
    const payVal = String(document.getElementById("paymentMethod").value||"").trim();
    const pay = paymentLabel(payVal);

    const rows = items.map(it=>{
      const name = escapeHtml(String(it.name||""));
      const qty = toNum(it.qty);
      const unit = toNum(it.unit_price).toFixed(2);
      const line = (toNum(it.qty)*toNum(it.unit_price)).toFixed(2);
      return `<tr>
        <td>${name}</td>
        <td class="num">${qty}</td>
        <td class="num">${unit}</td>
        <td class="num">${line}</td>
      </tr>`;
    }).join("");

    area.innerHTML = `
      <div class="receipt">
        <h3>B.S Medical & Aesthetic</h3>
        <div class="rmeta">
          <div><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> ${escapeHtml(invDisp || invNo)}</div>
          ${invNo ? `<div><span style="color:#555">Ø±Ù‚Ù… Ø§Ù„Ù†Ø¸Ø§Ù…:</span> ${escapeHtml(invNo)}</div>` : ""}
          <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${escapeHtml(invDate||"")}</div>
          <div><strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</strong> ${escapeHtml(pay)}</div>
          ${customer ? `<div><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${escapeHtml(customer)}</div>` : ""}
          ${phone ? `<div><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> <span style="direction:ltr;display:inline-block">${escapeHtml(phone)}</span></div>` : ""}
          ${address ? `<div><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${escapeHtml(address)}</div>` : ""}
        </div>

        <table>
          <thead>
            <tr>
              <th>Ø§Ù„ØµÙ†Ù</th>
              <th class="num">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
              <th class="num">Ø³Ø¹Ø±</th>
              <th class="num">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
            </tr>
          </thead>
          <tbody>
            ${rows || `<tr><td colspan="4">â€”</td></tr>`}
          </tbody>
        </table>

        <div class="rtotals">
          <div class="line"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…</span><span class="num">${Number(subtotal||0).toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></div>
          <div class="line"><span>Ø§Ù„Ø®ØµÙ…</span><span class="num">${Number(discount||0).toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></div>
          <div class="line"><span>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</span><span class="num">${Number(tax||0).toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></div>
          <div class="line"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</strong><strong class="num">${Number(total||0).toFixed(2)} Ø¬Ù†ÙŠÙ‡</strong></div>
        </div>

        <div class="rfooter">
          Axentro â€“ All Rights Reserved 2024 Â©<br/>
          By Ahmed Hamouda
        </div>
      </div>
    `;
  }

  function render() {
    const body = document.getElementById('itemsBody');
    body.innerHTML = '';
    let subtotal = 0;

    items.forEach((it, idx)=>{
      const lineTotal = toNum(it.qty) * toNum(it.unit_price);
      subtotal += lineTotal;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td class="prodCell">${escapeHtml(it.name || '')}<div class="muted" style="margin-top:4px">${escapeHtml(it.product_id || '')}</div></td>
        <td>${escapeHtml(it.barcode)}</td>
        <td>${toNum(it.qty)}</td>
        <td>${toNum(it.unit_price).toFixed(2)}</td>
        <td>${lineTotal.toFixed(2)}</td>
        <td><button class="btn danger" data-del="${idx}" type="button">Ø­Ø°Ù</button></td>
      `;
      body.appendChild(tr);
    });

    body.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const i = Number(btn.getAttribute('data-del'));
        items.splice(i,1);
        render();
      });
    });

    const discount = toNum(document.getElementById('discount').value);
    const tax = toNum(document.getElementById('tax').value);
    const total = subtotal - discount + tax;

    const totals = document.getElementById('totals');
    totals.innerHTML = `
      <div class="tline"><span class="muted">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…</span><span>${subtotal.toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></div>
      <div class="tline"><span class="muted">Ø§Ù„Ø®ØµÙ…</span><span>${discount.toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></div>
      <div class="tline"><span class="muted">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</span><span>${tax.toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></div>
      <div class="tline primary"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span><span>${total.toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></div>
    `;
    updatePrintArea(subtotal, discount, tax, total);
  }

  function resetItemInputs(){
    document.getElementById('barcode').value = '';
    document.getElementById('qty').value = '1';
    document.getElementById('unitPrice').value = '0';
    document.getElementById('productName').value = '';
    document.getElementById('productSku').textContent = '';
  }

  function findProductByBarcode(code){
    const b = String(code||'').trim();
    if(!b) return null;
    return products.find(p => String(p.barcode||'').trim() === b) || null;
  }

  async function loadProducts(){
    try {
      const res = await AxentroApi.getProducts();
      products = (res && res.products) ? res.products : [];
    } catch(e) {
      products = [];
      toast('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…');
    }
  }

  // Add item
  document.getElementById('barcode').addEventListener('input', ()=>{
    const code = document.getElementById('barcode').value;
    const p = findProductByBarcode(code);
    if(p){
      document.getElementById('productName').value = p.name || '';
      document.getElementById('productSku').textContent = (p.sku ? ('SKU: ' + p.sku) : '');
    } else {
      document.getElementById('productName').value = '';
      document.getElementById('productSku').textContent = '';
    }
  });

  document.getElementById('addItemBtn').addEventListener('click', ()=>{
    const barcode = String(document.getElementById('barcode').value||'').trim();
    const qty = Math.max(1, Math.floor(toNum(document.getElementById('qty').value)));
    const unit_price = Math.max(0, toNum(document.getElementById('unitPrice').value));

    if(!barcode){
      toast('Ø§ÙƒØªØ¨/Ø§Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹');
      return;
    }

    const p = findProductByBarcode(barcode);
    const name = p ? (p.name||'') : 'Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
    const product_id = p ? (p.product_id||'') : '';

    items.push({ barcode, qty, unit_price, name, product_id });
    resetItemInputs();
    render();
  });

  document.getElementById('discount').addEventListener('input', render);
  document.getElementById('tax').addEventListener('input', render);

  // Save
  document.getElementById('saveBtn').addEventListener('click', async ()=>{
    if(!items.length){
      toast('Ø£Ø¶Ù Ø£ØµÙ†Ø§Ù Ø£ÙˆÙ„Ø§Ù‹');
      return;
    }

    const customer = String(document.getElementById('customer').value||'').trim();
    const invoiceDate = document.getElementById('invDate').value || '';
    const discount = toNum(document.getElementById('discount').value);
    const tax = toNum(document.getElementById('tax').value);
    const payment_method = document.getElementById('paymentMethod').value || '';
    const notes = String(document.getElementById('notes').value||'').trim();
    const phone = String((document.getElementById('customerPhone')||{}).value||'').trim();
    const address = String((document.getElementById('customerAddress')||{}).value||'').trim();

    const payload = {
      customer,
      phone,
      address,
      payment_method,
      invoice_date: invoiceDate ? (invoiceDate + 'T00:00:00') : null,
      discount,
      tax,
      notes,
      items: items.map(it=>({
        barcode: it.barcode,
        qty: it.qty,
        unit_price: it.unit_price
      }))
    };

    try {
      const res = await AxentroApi.createSale(payload);
      if(res && res.ok) {
        const no = res.sale_invoice_no || 'SA';
        document.getElementById('invNo').value = no;
        updateInvoiceDisplay();
        const disp = String(document.getElementById('invDisplayNo').value||'').trim();
        toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ… Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + (disp || no));
        items = [];
        render();
        resetItemInputs();
      } else {
        toast((res && (res.error || res.message)) ? (res.error || res.message) : 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸');
      }
    } catch(e) {
      toast(String(e && e.message ? e.message : e));
    }
  });

  // Reset
  document.getElementById('resetBtn').addEventListener('click', ()=>{
    items = [];
    resetItemInputs();
    render();
    toast('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·');
  });

  // ===== Scanner =====
  const scanModal = document.getElementById('scanModal');
  const scanBtn = document.getElementById('scanBtn');
  const closeScanBtn = document.getElementById('closeScanBtn');
  const cameraSelect = document.getElementById('cameraSelect');
  const video = document.getElementById('video');
  const manualFillBtn = document.getElementById('manualFillBtn');
  const torchBtn = document.getElementById('torchBtn');

  let stream = null;
  let detector = null;
  let scanTimer = null;
  let track = null;

  function stopScan() {
    if(scanTimer) { clearInterval(scanTimer); scanTimer = null; }
    if(stream) {
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
    track = null;
    torchBtn.style.display = 'none';
    scanModal.classList.remove('show');
    scanModal.setAttribute('aria-hidden','true');
  }

  async function listCameras() {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d=>d.kind === 'videoinput');
    cameraSelect.innerHTML = '';
    cams.forEach((c, idx)=>{
      const opt = document.createElement('option');
      opt.value = c.deviceId;
      opt.textContent = c.label || ('ÙƒØ§Ù…ÙŠØ±Ø§ ' + (idx+1));
      cameraSelect.appendChild(opt);
    });
    return cams;
  }

  async function startStream(deviceId) {
    if(stream) {
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
    const constraints = {
      video: deviceId ? { deviceId: { exact: deviceId }, width:{ideal:1280}, height:{ideal:720} } : { facingMode: { ideal: 'environment' }, width:{ideal:1280}, height:{ideal:720} },
      audio: false
    };
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    await video.play();
    track = stream.getVideoTracks()[0] || null;

    try {
      const caps = track && track.getCapabilities ? track.getCapabilities() : null;
      torchBtn.style.display = (caps && caps.torch) ? 'inline-block' : 'none';
    } catch(e) {
      torchBtn.style.display = 'none';
    }
  }

  async function openScan() {
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      toast('Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­');
      return;
    }
    scanModal.classList.add('show');
    scanModal.setAttribute('aria-hidden','false');

    let cams = [];
    try { cams = await listCameras(); } catch(e) {}

    try { await startStream(cameraSelect.value || null); } catch(e) {
      toast('ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§');
      return;
    }

    if('BarcodeDetector' in window) {
      try { detector = new BarcodeDetector({ formats: ['ean_13','ean_8','code_128','code_39','qr_code','upc_a','upc_e'] }); }
      catch(e) { detector = null; }
    } else {
      detector = null;
    }

    scanTimer = setInterval(async ()=>{
      try {
        if(detector) {
          const codes = await detector.detect(video);
          if(codes && codes[0] && codes[0].rawValue) {
            document.getElementById('barcode').value = codes[0].rawValue;
            document.getElementById('barcode').dispatchEvent(new Event('input'));
            stopScan();
            toast('ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ âœ…');
          }
        }
      } catch(e) {}
    }, 180);
  }

  scanBtn.addEventListener('click', openScan);
  closeScanBtn.addEventListener('click', stopScan);
  scanModal.addEventListener('click', (e)=>{ if(e.target === scanModal) stopScan(); });

  cameraSelect.addEventListener('change', async ()=>{
    try { await startStream(cameraSelect.value); } catch(e) { toast('ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§'); }
  });

  manualFillBtn.addEventListener('click', ()=>{
    stopScan();
    document.getElementById('barcode').focus();
  });

  torchBtn.addEventListener('click', async ()=>{
    if(!track) return;
    try {
      const settings = track.getSettings ? track.getSettings() : {};
      const torchOn = settings.torch === true;
      await track.applyConstraints({ advanced: [{ torch: !torchOn }] });
    } catch(e) {
      toast('Ø§Ù„ÙÙ„Ø§Ø´ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…');
    }
  });

  // init
  try{
    const invDateEl = document.getElementById('invDate');
    if(invDateEl && (!invDateEl.value || String(invDateEl.value).trim()==='')) invDateEl.value = todayISO();
  }catch(e){}
  updateInvoiceDisplay();
  document.getElementById('invDate').addEventListener('change', ()=>{ updateInvoiceDisplay(); render(); });
  document.getElementById('invNo').addEventListener('input', updateInvoiceDisplay);

  function doPrint(mode){
    document.body.setAttribute('data-print', mode);
    setPrintPageStyle(mode);
    try{ render(); }catch(e){}
    window.print();
    setTimeout(()=>{ document.body.removeAttribute('data-print'); }, 300);
  }
  document.getElementById('print80').addEventListener('click', ()=>doPrint('thermal80'));
  document.getElementById('print58').addEventListener('click', ()=>doPrint('thermal58'));
  document.getElementById('printA4').addEventListener('click', ()=>doPrint('a4'));
  document.getElementById('pdfA4').addEventListener('click', ()=>doPrint('a4'));

  loadProducts().finally(()=>{ render(); resetItemInputs(); });
})();
</script>
</body>
</html>
