<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª â€” B.S Medical & Aesthetic</title>

  <style>
    :root{
      --bg:#f7f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --stroke:rgba(15,23,42,.10); --shadow:0 18px 50px rgba(2,6,23,.12);
      --radius:18px; --gold:#b08d57; --gold2:#d7b97a;
      --container-max:1100px;

      --ok:#16a34a; --okSoft: rgba(22,163,74,.10);
      --warn:#f59e0b; --warnSoft: rgba(245,158,11,.12);
      --bad:#dc2626; --badSoft: rgba(220,38,38,.10);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui,-apple-system,"Segoe UI",Tahoma,Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 10% 10%, rgba(176,141,87,.18), transparent 55%),
        radial-gradient(700px 500px at 90% 20%, rgba(215,185,122,.18), transparent 55%),
        linear-gradient(180deg, #ffffff, var(--bg));
      padding:18px; padding-bottom:calc(18px + env(safe-area-inset-bottom));
      min-height:100vh; display:flex; flex-direction:column;
      -webkit-font-smoothing:antialiased;
    }

    .wrap{max-width:var(--container-max);margin:0 auto;width:100%;flex:1}

    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 14px;border:1px solid var(--stroke);
      border-radius:18px;background:rgba(255,255,255,.86);
      box-shadow:var(--shadow);backdrop-filter:blur(10px);
      flex-wrap:wrap;margin-bottom:16px;
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:220px;}
    .logo{
      width:44px;height:44px;border-radius:999px;display:grid;place-items:center;
      background: linear-gradient(135deg, rgba(176,141,87,.22), rgba(215,185,122,.18));
      border:1px solid rgba(176,141,87,.35);
      box-shadow: 0 10px 24px rgba(2,6,23,.10);
      overflow:hidden;padding:6px;flex:0 0 auto;
    }
    .logo img{width:100%;height:100%;object-fit:contain;display:block}
    .brandTitle{font-weight:900}
    .brandSub{font-size:12px;color:var(--muted);margin-top:2px}
    .topActions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .card{
      background:rgba(255,255,255,.92);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin-bottom:16px;
    }

    h2{margin:0 0 10px;font-weight:900}
    label{font-size:12px;color:var(--muted); font-weight:900; display:block; margin-bottom:6px}
    input, textarea, select{
      width:100%;
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.14);
      background:#fff;
      color:var(--text);
      outline:none;
    }
    input::placeholder, textarea::placeholder{color:#94a3b8}
    @media (max-width:520px){ input,textarea,select{font-size:16px;} }

    #invNo{ font-weight:1000; }

    .row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .row2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .row1{display:grid;grid-template-columns:1fr;gap:10px}

    @media (max-width:920px){ .row{grid-template-columns:repeat(2,1fr);} .row2{grid-template-columns:1fr;} }
    @media (max-width:720px){
      .topbar{flex-direction:column;align-items:stretch}
      .topActions{justify-content:stretch}
      .topActions a,.topActions button{width:100%}
    }
    @media (max-width:520px){ .row{grid-template-columns:1fr;} }

    .btn{
      padding:12px; border-radius:14px;
      border:1px solid rgba(176,141,87,.35);
      background:linear-gradient(135deg, rgba(176,141,87,.18), rgba(215,185,122,.14));
      color:var(--text);
      font-weight:1000;
      cursor:pointer;
      touch-action: manipulation;
      line-height:1;
      white-space:nowrap;
    }
    .btn.secondary{border-color: rgba(15,23,42,.14); background:#fff; opacity:.95;}
    .btn.danger{border-color: rgba(220,38,38,.25); background:rgba(220,38,38,.06); color:#991b1b;}
    .btn:active{transform:translateY(1px)}

    .table-wrap{overflow:auto;margin-top:10px;border-radius:12px}
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      min-width:820px;
      background:#fff;
      border-radius:12px;
      overflow:hidden;
    }
    th,td{border:1px solid rgba(15,23,42,.10);padding:8px;text-align:center;vertical-align:middle;}
    th{background: linear-gradient(180deg, rgba(176,141,87,.10), rgba(215,185,122,.06));font-weight:1000;}
    .prodCell{text-align:right; font-weight:1000;}
    .muted{color:var(--muted); font-weight:900;}
    .totals{margin-top:12px; display:grid; gap:8px;}
    .tline{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;border:1px solid rgba(15,23,42,.10);
      border-radius:12px;background:#fff;font-weight:1000;
    }
    .tline .k{color:var(--muted); font-weight:900;}
    .tline.primary{
      border-color: rgba(176,141,87,.35);
      background: linear-gradient(135deg, rgba(176,141,87,.10), rgba(215,185,122,.08));
      font-size:14px;
    }
    .amountWords{
      margin-top:10px;
      font-weight:1000;
      color:#334155;
      border-top:1px dashed rgba(15,23,42,.14);
      padding-top:10px;
      line-height:1.6;
    }

    /* ===== Scanner modal (Ù†ÙØ³ Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…) ===== */
    .modalBack{
      position:fixed; inset:0; background:rgba(2,6,23,.55);
      display:none; align-items:center; justify-content:center;
      padding:16px; z-index:9999;
      backdrop-filter: blur(10px);
    }
    .modalBack.show{display:flex;}
    .modal{
      width:min(720px, 96vw);
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(15,23,42,.12);
      box-shadow:0 18px 50px rgba(2,6,23,.22);
      overflow:hidden;
    }
    .modalHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 14px;border-bottom:1px solid rgba(15,23,42,.10);
    }
    .modalHead .title{font-weight:1000}
    .modalBody{padding:12px 14px;}
    .videoWrap{
      position:relative; border-radius:16px; overflow:hidden;
      border:1px solid rgba(15,23,42,.10); background:#000;
    }
    video{width:100%; height:auto; display:block;}
    .scanFrame{
      position:absolute; inset:12%;
      border:2px solid rgba(176,141,87,.85);
      border-radius:18px;
      box-shadow:0 0 0 9999px rgba(0,0,0,.18) inset;
      pointer-events:none;
    }

    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.03);
      font-weight:1000;
      font-size:12px;
      line-height:1.7;
      display:none;
      word-break:break-word;
    }
    .msg.ok{border-color: rgba(22,163,74,.22); background: var(--okSoft); color:#14532d;}
    .msg.warn{border-color: rgba(245,158,11,.25); background: var(--warnSoft); color:#7c2d12;}
    .msg.bad{border-color: rgba(220,38,38,.22); background: var(--badSoft); color:#991b1b;}

    .toast{
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      background: rgba(15,23,42,.92); color: #fff;
      padding: 10px 12px; border-radius: 14px;
      box-shadow: 0 18px 50px rgba(2,6,23,.18);
      font-weight: 1000; font-size: 13px;
      opacity: 0; pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 99999; max-width: min(520px, 92vw); text-align:center;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px);}

    /* Footer */
    .site-footer{
      margin-top:auto;
      padding:16px 16px 18px;
      text-align:center;
      color:var(--muted);
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.78);
      backdrop-filter: blur(10px);
      border-radius:16px;
      width:min(520px, 92vw);
      margin-inline:auto;
      box-shadow: var(--shadow);
    }
    .site-footer .line1{ font-weight:1000; color:#0f172a; }
    .site-footer .line2{ margin-top:6px; font-weight:900; }

    .qrBox{ margin-top:14px; display:flex; justify-content:center; }
    .qrLink{
      text-decoration:none;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }
    .qrLink img{
      width:132px; height:132px; max-width:60vw;
      border-radius:14px; border:1px solid rgba(15,23,42,.12);
      background:#fff; padding:10px;
      box-shadow: 0 10px 26px rgba(2,6,23,.08);
      object-fit:contain;
      transition:transform .15s ease, box-shadow .15s ease;
    }
    .qrLink:hover img,
    .qrLink:active img{
      transform:scale(1.03);
      box-shadow:0 14px 34px rgba(2,6,23,.12);
    }
    .qrText{ font-size:12px; font-weight:1000; color:#334155; }
    :focus{ outline:3px solid rgba(176,141,87,.25); outline-offset:3px; }
  </style>
</head>

<body>
<div class="wrap" id="app">
  <div class="topbar">
    <div class="brand">
      <div class="logo">
        <img src="assets/logo.png" alt="BS Logo" onerror="this.onerror=null;this.src='images/bslogo.webp'">
      </div>
      <div>
        <div class="brandTitle">B.S Medical &amp; Aesthetic</div>
        <div class="brandSub">ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª <span style="opacity:.7">(Sales Invoice)</span></div>
      </div>
    </div>

    <div class="topActions">
      <a class="btn secondary" href="dashboard.html" style="text-decoration:none;">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯</a>
      <button class="btn secondary" id="logoutBtn" type="button">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <div class="card">
    <h2>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h2>

    <div class="row">
      <div>
        <label for="invNo">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
        <input id="invNo" value="SA001" readonly />
      </div>
      <div>
        <label for="invDate">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
        <input id="invDate" type="date" />
      </div>
      <div>
        <label for="paymentMethod">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
        <select id="paymentMethod">
          <option value="CASH">ÙƒØ§Ø´</option>
          <option value="VISA">ÙÙŠØ²Ø§</option>
          <option value="INSTAPAY">Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ</option>
          <option value="EWALLET">Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
        </select>
      </div>
      <div>
        <label for="customerName">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
        <input id="customerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
      </div>
    </div>

    <div class="row2" style="margin-top:10px">
      <div>
        <label for="customerPhone">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
        <input id="customerPhone" placeholder="01xxxxxxxxx Ø£Ùˆ +201xxxxxxxxx" inputmode="tel" />
      </div>
      <div>
        <label for="customerAddress">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
        <input id="customerAddress" placeholder="Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© / Ø§Ù„Ù…Ù†Ø·Ù‚Ø© / ØªÙØ§ØµÙŠÙ„" />
      </div>
    </div>

    <div class="row2" style="margin-top:10px">
      <div>
        <label for="discount">Ø§Ù„Ø®ØµÙ… (Ø¹Ù„Ù‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©) â€” Ø¬Ù†ÙŠÙ‡</label>
        <input id="discount" type="number" step="0.01" min="0" value="0" />
      </div>
      <div>
        <label for="shipping">Ø§Ù„Ø´Ø­Ù† / Ø§Ù„ØªÙˆØµÙŠÙ„ â€” Ø¬Ù†ÙŠÙ‡</label>
        <input id="shipping" type="number" step="0.01" min="0" value="0" />
      </div>
    </div>

    <div class="row1" style="margin-top:10px">
      <div>
        <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
        <input id="notes" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" />
      </div>
    </div>

    <div id="msgOk" class="msg ok"></div>
    <div id="msgWarn" class="msg warn"></div>
    <div id="msgBad" class="msg bad"></div>
  </div>

  <div class="card">
    <h2>Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</h2>

    <div class="row">
      <div>
        <label for="barcode">Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <input id="barcode" placeholder="Ø§Ù…Ø³Ø­ Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯" inputmode="numeric" autocomplete="off" />
          <button class="btn secondary" id="scanBtn" type="button">ğŸ“· Ù…Ø³Ø­</button>
        </div>
      </div>

      <div>
        <label for="productSearch" style="margin-top:10px">Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input id="productSearch" list="productNameList" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù Ù„Ù„Ø¨Ø­Ø«..." autocomplete="off" />
        <datalist id="productNameList"></datalist>
      </div>

      <div>
        <label for="qty">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
        <input id="qty" type="number" step="1" min="1" value="1" />
      </div>
      <div>
        <label for="unitPrice">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</label>
        <input id="unitPrice" type="number" step="0.01" min="0" placeholder="0" />
      </div>
      <div>
        <label for="productName">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
        <input id="productName" readonly placeholder="Ø³ÙŠØ¸Ù‡Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯" />
      </div>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
      <button class="btn" id="addItemBtn" type="button">ï¼‹ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
    </div>

    <div class="table-wrap">
      <table aria-label="Sales items">
        <thead>
          <tr>
            <th style="width:60px">#</th>
            <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th style="width:140px">Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
            <th style="width:100px">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th style="width:140px">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
            <th style="width:160px">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
            <th style="width:110px">Ø­Ø°Ù</th>
          </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>
    </div>

    <div class="totals" id="totals"></div>
    <div class="amountWords" id="amountWords" style="display:none"></div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
      <button class="btn" id="saveBtn" type="button">ğŸ’¾ Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
      <button class="btn secondary" id="resetBtn" type="button">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
    </div>

    <div class="row2" style="margin-top:12px">
      <button class="btn secondary" id="thermal80Btn" type="button">ğŸ§¾ Ø·Ø¨Ø§Ø¹Ø© Ø­Ø±Ø§Ø±ÙŠ 80mm</button>
      <button class="btn secondary" id="thermal58Btn" type="button">ğŸ§¾ Ø·Ø¨Ø§Ø¹Ø© Ø­Ø±Ø§Ø±ÙŠ 58mm</button>
    </div>

    <div class="row2" style="margin-top:10px">
      <button class="btn secondary" id="printA4Btn" type="button">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© A4</button>
      <button class="btn secondary" id="savePdfA4Btn" type="button">ğŸ“„ Ø­ÙØ¸ PDF Ù„Ù€ A4</button>
    </div>
  </div>
</div>

<!-- Scanner Modal -->
<div class="modalBack" id="scanModal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Barcode Scanner">
    <div class="modalHead">
      <div class="title">ğŸ“· Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</div>
      <button class="btn secondary" id="closeScanBtn" type="button">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="modalBody">
      <div class="row2" style="margin-bottom:10px">
        <div>
          <label for="cameraSelect">Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</label>
          <select id="cameraSelect"></select>
        </div>
        <div>
          <label>Ù…Ø³Ø§Ø¹Ø¯Ø©</label>
          <div class="muted" style="padding:10px 12px;border:1px solid rgba(15,23,42,.10);border-radius:12px;background:#fff;">
            Ø¶Ø¹ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø°Ù‡Ø¨ÙŠ.
          </div>
        </div>
      </div>

      <div class="videoWrap">
        <video id="video" playsinline></video>
        <div class="scanFrame"></div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
        <button class="btn secondary" id="torchBtn" type="button" style="display:none;">ğŸ”¦ ÙÙ„Ø§Ø´</button>
        <button class="btn secondary" id="manualFillBtn" type="button">Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<footer class="site-footer">
  <div class="line1">Axentro â€“ All Rights Reserved 2024 Â©</div>
  <div class="line2">By Ahmed Hamouda</div>

  <div class="qrBox">
    <a class="qrLink" href="https://axentro-official.github.io/axentro-website/links.html" target="_blank" rel="noopener">
      <img src="assets/qr.png" alt="QR Code">
      <span class="qrText">Scan me</span>
    </a>
  </div>
</footer>

<script src="config.js"></script>
<script src="app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
<script>AxentroAuth.requireAuth();</script>

<script>
(function(){
  "use strict";

  const toastEl = document.getElementById('toast');
  function toast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(()=>toastEl.classList.remove('show'), 2200);
  }

  const elMsg = {
    ok: document.getElementById('msgOk'),
    warn: document.getElementById('msgWarn'),
    bad: document.getElementById('msgBad'),
  };
  function showMsg(type, text){
    elMsg.ok.style.display = "none";
    elMsg.warn.style.display = "none";
    elMsg.bad.style.display = "none";
    if(!text) return;
    const box = type === "ok" ? elMsg.ok : (type === "warn" ? elMsg.warn : elMsg.bad);
    box.textContent = text;
    box.style.display = "block";
  }

  const logoutBtn = document.getElementById('logoutBtn');
  logoutBtn.addEventListener('click', (e)=>{ e.preventDefault(); AxentroAuth.logout(); });

  // ===== Products cache (by barcode) =====
  let productsByBarcode = new Map();
  let productsList = [];

  async function loadProducts() {
    try {
      const res = await AxentroApi.getProducts();
      if(res && res.ok && Array.isArray(res.products)) {
        productsList = res.products.slice();
        productsByBarcode = new Map(productsList.map(p=>[String(p.barcode), p]));

        // Build datalist for name search (optional)
        if(productNameList){
          const seen = new Set();
          productNameList.innerHTML = "";
          for(const p of productsList){
            const name = String(p?.name || "").trim();
            if(!name) continue;
            const k = name.toLowerCase();
            if(seen.has(k)) continue;
            seen.add(k);
            const opt = document.createElement("option");
            opt.value = name;
            productNameList.appendChild(opt);
          }
        }
      }
    } catch(e) {
      // ignore
    }
  }

  function toNum(v) {
    const n = Number(v);
    return isNaN(n) ? 0 : n;
  }

  function esc(s){
    return String(s||'')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  // ===== Invoice date default =====
  (function setDefaultDate(){
    try{
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      document.getElementById('invDate').value = `${yyyy}-${mm}-${dd}`;
    }catch(e){}
  })();

  // ===== Amount to Arabic words =====
  function numberToArabicWords(number){
    number = Number(number) || 0;
    if(number === 0) return "0 Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ ÙÙ‚Ø· Ù„Ø§ ØºÙŠØ±";
    const ones = ["","ÙˆØ§Ø­Ø¯","Ø§Ø«Ù†Ø§Ù†","Ø«Ù„Ø§Ø«Ø©","Ø£Ø±Ø¨Ø¹Ø©","Ø®Ù…Ø³Ø©","Ø³ØªØ©","Ø³Ø¨Ø¹Ø©","Ø«Ù…Ø§Ù†ÙŠØ©","ØªØ³Ø¹Ø©","Ø¹Ø´Ø±Ø©","Ø£Ø­Ø¯ Ø¹Ø´Ø±","Ø§Ø«Ù†Ø§ Ø¹Ø´Ø±","Ø«Ù„Ø§Ø«Ø© Ø¹Ø´Ø±","Ø£Ø±Ø¨Ø¹Ø© Ø¹Ø´Ø±","Ø®Ù…Ø³Ø© Ø¹Ø´Ø±","Ø³ØªØ© Ø¹Ø´Ø±","Ø³Ø¨Ø¹Ø© Ø¹Ø´Ø±","Ø«Ù…Ø§Ù†ÙŠØ© Ø¹Ø´Ø±","ØªØ³Ø¹Ø© Ø¹Ø´Ø±"];
    const tens = ["","Ø¹Ø´Ø±Ø©","Ø¹Ø´Ø±ÙˆÙ†","Ø«Ù„Ø§Ø«ÙˆÙ†","Ø£Ø±Ø¨Ø¹ÙˆÙ†","Ø®Ù…Ø³ÙˆÙ†","Ø³ØªÙˆÙ†","Ø³Ø¨Ø¹ÙˆÙ†","Ø«Ù…Ø§Ù†ÙˆÙ†","ØªØ³Ø¹ÙˆÙ†"];
    const hundreds = ["","Ù…Ø§Ø¦Ø©","Ù…Ø§Ø¦ØªØ§Ù†","Ø«Ù„Ø§Ø«Ù…Ø§Ø¦Ø©","Ø£Ø±Ø¨Ø¹Ù…Ø§Ø¦Ø©","Ø®Ù…Ø³Ù…Ø§Ø¦Ø©","Ø³ØªÙ…Ø§Ø¦Ø©","Ø³Ø¨Ø¹Ù…Ø§Ø¦Ø©","Ø«Ù…Ø§Ù†Ù…Ø§Ø¦Ø©","ØªØ³Ø¹Ù…Ø§Ø¦Ø©"];
    function subThousand(n){
      n = Number(n); if(n===0) return "";
      let res=[]; const h=Math.floor(n/100); const rest=n%100;
      if(h) res.push(hundreds[h]);
      if(rest){
        if(rest<20) res.push(ones[rest]);
        else{
          const t=Math.floor(rest/10), o=rest%10;
          if(o) res.push(ones[o]+" Ùˆ "+tens[t]); else res.push(tens[t]);
        }
      }
      return res.join(" Ùˆ ");
    }
    let parts=[];
    const million=Math.floor(number/1000000);
    const thousand=Math.floor((number%1000000)/1000);
    const rest=number%1000;
    if(million){ if(million===1) parts.push("Ù…Ù„ÙŠÙˆÙ†"); else if(million===2) parts.push("Ù…Ù„ÙŠÙˆÙ†Ø§Ù†"); else parts.push(subThousand(million)+" Ù…Ù„ÙŠÙˆÙ†"); }
    if(thousand){ if(thousand===1) parts.push("Ø£Ù„Ù"); else if(thousand===2) parts.push("Ø£Ù„ÙØ§Ù†"); else parts.push(subThousand(thousand)+" Ø£Ù„Ù"); }
    if(rest) parts.push(subThousand(rest));
    return `${parts.join(" Ùˆ ")} Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ ÙÙ‚Ø· Ù„Ø§ ØºÙŠØ±`;
  }

  // ===== Items state =====
  let items = []; // {barcode, product_id, name, qty, unit_price}

  const barcodeInp = document.getElementById('barcode');
  const qtyInp = document.getElementById('qty');
  const unitPriceInp = document.getElementById('unitPrice');
  const productNameInp = document.getElementById('productName');

  function fillProductNameByBarcode() {
    const b = String(barcodeInp.value || "").trim();
    const p = productsByBarcode.get(b);
    if (p) {
      productNameInp.value = p.name || "";
      if (productSearchInp) productSearchInp.value = p.name || "";
    } else {
      productNameInp.value = "";
      // Ù„Ø§ Ù†Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙƒØªØ¨)
    }
  }

  barcodeInp.addEventListener('input', fillProductNameByBarcode);

  if (productSearchInp) {
    const applyNameSearch = () => {
      const q = String(productSearchInp.value || "").trim();
      if (!q) return;
      const ql = q.toLowerCase();

      let hit = productsList.find(p => String(p?.name || "").trim().toLowerCase() === ql);
      if (!hit) hit = productsList.find(p => String(p?.name || "").trim().toLowerCase().includes(ql));

      if (hit && hit.barcode) {
        barcodeInp.value = String(hit.barcode);
        fillProductNameByBarcode();
      }
    };

    productSearchInp.addEventListener('change', applyNameSearch);
    productSearchInp.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        applyNameSearch();
      }
    });
  }
  barcodeInp.addEventListener('change', fillProductNameByBarcode);

  function resetItemInputs() {
    barcodeInp.value = '';
    qtyInp.value = 1;
    unitPriceInp.value = '';
    productNameInp.value = '';
    barcodeInp.focus();
  }

  function calcTotals(){
    let totalBefore = 0;
    items.forEach(it=>{
      totalBefore += (toNum(it.qty) * toNum(it.unit_price));
    });

    const discount = Math.max(0, toNum(document.getElementById('discount').value));
    const afterDiscount = Math.max(0, totalBefore - discount);

    const shipping = Math.max(0, toNum(document.getElementById('shipping').value));
    const finalTotal = afterDiscount + shipping;

    return { totalBefore, discount, afterDiscount, shipping, finalTotal };
  }

  function render() {
    const body = document.getElementById('itemsBody');
    body.innerHTML = '';

    items.forEach((it, idx)=>{
      const lineTotal = toNum(it.qty) * toNum(it.unit_price);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td class="prodCell">${esc(it.name || '')}<div class="muted" style="margin-top:4px">${esc(it.product_id || '')}</div></td>
        <td>${esc(it.barcode)}</td>
        <td>${toNum(it.qty)}</td>
        <td>${toNum(it.unit_price).toFixed(2)}</td>
        <td>${lineTotal.toFixed(2)}</td>
        <td><button class="btn danger" data-del="${idx}" type="button">Ø­Ø°Ù</button></td>
      `;
      body.appendChild(tr);
    });

    body.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const i = Number(btn.getAttribute('data-del'));
        items.splice(i,1);
        render();
      });
    });

    const t = calcTotals();
    const deliveryText = t.shipping > 0 ? `${t.shipping.toFixed(2)} Ø¬Ù†ÙŠÙ‡` : "ØªÙˆØµÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ";

    const totals = document.getElementById('totals');
    totals.innerHTML = `
      <div class="tline"><span class="k">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…</span><span>${t.totalBefore.toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></div>
      <div class="tline"><span class="k">Ø§Ù„Ø®ØµÙ…</span><span>${t.discount.toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></div>
      <div class="tline"><span class="k">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¯ÙˆÙ† Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø­Ù† / Ø§Ù„ØªÙˆØµÙŠÙ„</span><span>${t.afterDiscount.toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></div>
      <div class="tline"><span class="k">Ø§Ù„Ø´Ø­Ù† / Ø§Ù„ØªÙˆØµÙŠÙ„</span><span>${deliveryText}</span></div>
      <div class="tline primary"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span>${t.finalTotal.toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></div>
    `;

    const wordsEl = document.getElementById('amountWords');
    wordsEl.style.display = "block";
    wordsEl.textContent = numberToArabicWords(Math.round(t.finalTotal));
  }

  document.getElementById('discount').addEventListener('input', render);
  document.getElementById('shipping').addEventListener('input', render);

  document.getElementById('addItemBtn').addEventListener('click', ()=>{
    const barcode = String(barcodeInp.value||'').trim();
    const qty = toNum(qtyInp.value);
    const unit_price = toNum(unitPriceInp.value);

    if(!barcode) return toast('Ø§ÙƒØªØ¨/Ø§Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹');
    if(qty <= 0) return toast('Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
    if(unit_price < 0) return toast('Ø§Ù„Ø³Ø¹Ø± ØºÙŠØ± ØµØ­ÙŠØ­');

    const p = productsByBarcode.get(barcode);
    items.push({
      barcode,
      product_id: p ? (p.product_id || '') : '',
      name: p ? (p.name||'') : '',
      qty,
      unit_price
    });

    render();
    resetItemInputs();
  });

  document.getElementById('resetBtn').addEventListener('click', ()=>{
    items = [];
    document.getElementById('customerName').value = '';
    document.getElementById('customerPhone').value = '';
    document.getElementById('customerAddress').value = '';
    document.getElementById('notes').value = '';
    document.getElementById('discount').value = 0;
    document.getElementById('shipping').value = 0;
    render();
    resetItemInputs();
    showMsg("ok", "ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·.");
    setTimeout(()=>showMsg("", ""), 1500);
  });

  // ===== Save to system (tax removed Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©ØŒ Ø¨Ø³ Ù†Ø±Ø³Ù„Ù‡ 0 Ø¹Ù„Ø´Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚) =====
  document.getElementById('saveBtn').addEventListener('click', async ()=>{
    if(items.length === 0) return toast('Ø£Ø¶Ù ØµÙ†Ù ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');

    const customer_name = String(document.getElementById('customerName').value||'').trim();
    if(!customer_name) return toast('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„');

    const invoiceDate = document.getElementById('invDate').value; // yyyy-mm-dd
    const payment_method = document.getElementById('paymentMethod').value || '';
    const notes = String(document.getElementById('notes').value||'').trim();

    const t = calcTotals();

    const payload = {
      customer: customer_name,
      customer_phone: String(document.getElementById('customerPhone').value||'').trim(),
      customer_address: String(document.getElementById('customerAddress').value||'').trim(),
      invoice_date: invoiceDate ? (invoiceDate + 'T00:00:00') : null,
      discount: t.discount,
      tax: 0,
      shipping_fee: t.shipping,
      payment_method,
      notes,
      items: items.map(it=>({
        barcode: it.barcode,
        qty: it.qty,
        unit_price: it.unit_price
      }))
    };

    try {
      showMsg("warn","Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...");
      const res = await AxentroApi.createSale(payload);
      if(res && res.ok) {
        const no = res.sale_invoice_no || 'SA';
        document.getElementById('invNo').value = no;
        showMsg("ok",'ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ… Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + no);
        toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…');
        items = [];
        render();
        resetItemInputs();
      } else {
        showMsg("bad", (res && (res.error || res.message)) ? (res.error || res.message) : 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸');
      }
    } catch(e) {
      showMsg("bad", String(e && e.message ? e.message : e));
    }
  });

  // ===== Print builders (Ù…Ø£Ø®ÙˆØ° Ù…Ù† Ù…Ø¨Ø¯Ø£ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…) =====
  function openPrintWindow(html, title){
    const w = window.open("", "_blank");
    if(!w){ alert("Pop-up blocked. Ø§Ø³Ù…Ø­ Ø¨ÙØªØ­ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©."); return; }
    w.document.open(); w.document.write(html); w.document.close();
    try{ w.document.title = title || "ÙØ§ØªÙˆØ±Ø©"; }catch(e){}
    w.onload = function(){ w.focus(); setTimeout(()=> w.print(), 250); };
  }

  function getInvoiceData(){
    const d = new Date();
    const invNo = String(document.getElementById('invNo').value || '');
    const invDate = String(document.getElementById('invDate').value || '');
    const invTime = d.toLocaleTimeString("en-US",{hour:'2-digit',minute:'2-digit',hour12:true});
    const customerName = String(document.getElementById('customerName').value || '').trim();
    const customerPhone = String(document.getElementById('customerPhone').value || '').trim();
    const customerAddress = String(document.getElementById('customerAddress').value || '').trim();
    const notes = String(document.getElementById('notes').value || '').trim();
    const paymentMethod = String(document.getElementById('paymentMethod').value || '').trim();

    const t = calcTotals();
    const words = numberToArabicWords(Math.round(t.finalTotal));

    const itemsOut = items.map((it, idx)=>({
      idx: idx+1,
      barcode: it.barcode,
      name: it.name || "",
      qty: toNum(it.qty),
      unit_price: toNum(it.unit_price),
      line_total: toNum(it.qty) * toNum(it.unit_price),
      product_id: it.product_id || ""
    }));

    return {
      invNo, invDate, invTime,
      customerName, customerPhone, customerAddress,
      paymentMethod, notes,
      items: itemsOut,
      totalBefore: t.totalBefore,
      discount: t.discount,
      afterDiscount: t.afterDiscount,
      shipping: t.shipping,
      finalTotal: t.finalTotal,
      words
    };
  }

  function buildA4Html(d){
    const deliveryText = (Number(d.shipping||0) > 0) ? `${Number(d.shipping).toFixed(2)} Ø¬Ù†ÙŠÙ‡` : "ØªÙˆØµÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ";
    const noteHtml = d.notes ? `<div class="note">${esc(d.notes)}</div>` : "";

    const itemsHtml = d.items.length ? d.items.map(it => `
      <tr>
        <td>${it.idx}</td>
        <td style="text-align:right;font-weight:900">${esc((it.barcode ? it.barcode + " | " : "") + (it.name||""))}</td>
        <td>${Number(it.qty||0)}</td>
        <td>${Number(it.unit_price||0).toFixed(2)}</td>
        <td>${Number(it.line_total||0).toFixed(2)}</td>
      </tr>
    `).join("") : `<tr><td colspan="5" style="padding:18px;text-align:center;color:#64748b">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù</td></tr>`;

    return `
<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ÙØ§ØªÙˆØ±Ø© ${esc(d.invNo)}</title>
<style>
  :root{ --text:#0f172a; --muted:#64748b; --stroke: rgba(15,23,42,.10); }
  @page { size: A4; margin: 10mm; }
  body{font-family: Arial, Helvetica, sans-serif;color:var(--text);direction:rtl;margin:0;background:#fff;}
  .sheet{max-width:900px;margin:0 auto;}
  .card{background:#fff;border-radius:12px;padding:18px;margin-bottom:14px;border:1px solid var(--stroke);}
  .header{display:flex;justify-content:space-between;align-items:center;gap:12px;}
  .brand{display:flex;align-items:center;gap:12px}
  .brand img{width:64px;height:64px;object-fit:contain}
  h1{margin:0;font-weight:900}
  .meta{font-size:14px;color:var(--muted); line-height:1.7}
  .meta strong{color:#0f172a}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
  th,td{border:1px solid var(--stroke);padding:8px;text-align:center}
  th{background:#f7f7fb;font-weight:900}
  .totals{margin-top:12px;display:flex;flex-direction:column;gap:8px}
  .tline{display:flex;justify-content:space-between;gap:10px;border:1px solid var(--stroke);border-radius:10px;padding:10px 12px;background:#fff;font-weight:900}
  .tline span:first-child{color:#64748b;font-weight:900}
  .tline.primary{background:#f7f7fb;}
  .amountWords{margin-top:10px;font-weight:900;color:#334155}
  .note{margin-top:10px;border-top:1px dashed var(--stroke);padding-top:10px;font-weight:900;color:#334155}
  .custGrid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px}
  .custLine{border:1px dashed var(--stroke);border-radius:10px;padding:10px 12px}
  .qrWrap{margin-top:12px;display:flex;flex-direction:column;align-items:center;gap:8px}
  .qrWrap img{width:120px;height:120px;object-fit:contain;border:1px solid var(--stroke);border-radius:10px;padding:6px}
  .qrText{font-size:12px;color:#334155;font-weight:900}
  .footer{margin-top:10px;text-align:center;color:#64748b;font-size:12px;line-height:1.6}
</style>
</head>
<body>
<div class="sheet">

  <div class="card header">
    <div class="brand">
      <img src="assets/logo.png" onerror="this.onerror=null;this.src='images/bslogo.webp'">
      <div>
        <h1>B.S Medical &amp; Aesthetic</h1>
        <div class="meta">ÙØ§ØªÙˆØ±Ø©: <strong>${esc(d.invNo)}</strong></div>
        <div class="meta">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: <strong>${esc(d.paymentMethod)}</strong></div>
      </div>
    </div>

    <div class="meta" style="text-align:left">
      <div>Ø§Ù„ØªØ§Ø±ÙŠØ®: <strong>${esc(d.invDate)}</strong></div>
      <div>Ø§Ù„ÙˆÙ‚Øª: <strong>${esc(d.invTime)}</strong></div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px;font-weight:900;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
    <div class="custGrid">
      <div class="custLine"><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${esc(d.customerName || "â€”")}</div>
      <div class="custLine"><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${esc(d.customerPhone || "â€”")}</div>
      <div class="custLine"><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${esc(d.customerAddress || "â€”")}</div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px;font-weight:900;">Ø§Ù„Ø£ØµÙ†Ø§Ù</h3>
    <table>
      <thead>
        <tr><th>#</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr>
      </thead>
      <tbody>${itemsHtml}</tbody>
    </table>

    <div class="totals">
      <div class="tline"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…</span><span>${Number(d.totalBefore||0).toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></div>
      <div class="tline"><span>Ø§Ù„Ø®ØµÙ…</span><span>${Number(d.discount||0).toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></div>
      <div class="tline"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¯ÙˆÙ† Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø­Ù† / Ø§Ù„ØªÙˆØµÙŠÙ„</span><span>${Number(d.afterDiscount||0).toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></div>
      <div class="tline"><span>Ø§Ù„Ø´Ø­Ù† / Ø§Ù„ØªÙˆØµÙŠÙ„</span><span>${deliveryText}</span></div>
      <div class="tline primary"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span>${Number(d.finalTotal||0).toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></div>
    </div>

    <div class="amountWords">${esc(d.words)}</div>
    ${noteHtml}

    <div class="qrWrap">
      <img src="assets/qr.png" alt="QR">
      <div class="qrText">Ø§Ù…Ø³Ø­ Ø§Ù„Ù€ QR Ù„Ù„ØªÙˆØ§ØµÙ„</div>
    </div>

    <div class="footer">Axentro â€“ All Rights Reserved 2024 Â©<br>By Ahmed Hamouda</div>
  </div>

</div>
</body>
</html>`;
  }

  function buildThermalHtml(mm, d){
    const widthMm = (mm === 58) ? 58 : 80;
    const titleText = "ÙØ§ØªÙˆØ±Ø©";
    const deliveryText = (Number(d.shipping||0) > 0) ? Number(d.shipping).toFixed(2) : "Ù…Ø¬Ø§Ù†ÙŠ";

    const itemsHtml = d.items.length ? d.items.map(it=>{
      const name = ((it.barcode ? it.barcode + " | " : "") + (it.name||"")).trim();
      const qty  = Number(it.qty || 0);
      const price = Number(it.unit_price || 0);
      const sub   = Number(it.line_total || 0);
      return `
        <div class="item">
          <div class="itemName">${it.idx}) ${esc(name)}</div>
          <div class="itemMeta"><span class="l">Qty: ${qty} Ã— ${price.toFixed(2)}</span><span class="r"></span></div>
          <div class="itemTotal"><span>Total</span><span>${sub.toFixed(2)}</span></div>
        </div>
        <div class="sep"></div>
      `;
    }).join("") : `<div class="m" style="text-align:center;margin:10px 0">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù</div>`;

    const noteBlock = d.notes ? `<div class="sep"></div><div class="m">${esc(d.notes)}</div>` : "";

    return `
<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>${titleText} ${esc(d.invNo)}</title>
<style>
  @page { size: ${widthMm}mm auto; margin: 3mm; }
  body{margin:0;font-family: Arial, Tahoma, sans-serif;color:#000;direction:rtl;background:#fff;}
  .paper{ width:${widthMm}mm; margin:0 auto; padding:0; }
  .center{text-align:center}
  .b{font-weight:900;font-size:13px;line-height:1.45}
  .m{font-weight:700;font-size:11px;line-height:1.55}
  .sep{border-top:1px dashed #000;margin:8px 0}
  .totRow{display:flex;justify-content:space-between;gap:8px;font-weight:900;font-size:12px}
  .totMain{font-size:14px}
  .qr{display:flex;flex-direction:column;align-items:center;gap:6px;margin-top:8px}
  .qr img{width:${widthMm===58? 90:110}px;height:${widthMm===58? 90:110}px;object-fit:contain}
  .foot{margin-top:8px;font-size:10px;color:#000;text-align:center;line-height:1.5}
  .logo{width:${widthMm===58? 46:56}px;height:${widthMm===58? 46:56}px;object-fit:contain;display:block;margin:0 auto 6px}
  .item{padding:6px 0}
  .itemName{font-weight:900;font-size:12px;line-height:1.5}
  .itemMeta{display:flex;justify-content:space-between;gap:8px;font-weight:700;font-size:11px;line-height:1.6;margin-top:2px}
  .itemMeta .l,.itemMeta .r{direction:ltr;text-align:left;unicode-bidi:embed}
  .itemTotal{display:flex;justify-content:space-between;gap:8px;margin-top:2px;font-weight:900;font-size:12px;direction:ltr;text-align:left;unicode-bidi:embed}
  *{break-inside: avoid; page-break-inside: avoid;}
  html,body{height:auto}
</style>
</head>
<body>
<div class="paper">
  <div class="center">
    <img class="logo" src="assets/logo.png" onerror="this.onerror=null;this.src='images/bslogo.webp'">
    <div class="b">B.S Medical &amp; Aesthetic</div>
    <div class="m">${titleText}: <strong>${esc(d.invNo)}</strong></div>
    <div class="m">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: <strong>${esc(d.paymentMethod)}</strong></div>
  </div>

  <div class="sep"></div>
  <div class="m">ØªØ§Ø±ÙŠØ®: <strong>${esc(d.invDate)}</strong></div>
  <div class="m">ÙˆÙ‚Øª: <strong>${esc(d.invTime)}</strong></div>

  <div class="sep"></div>
  <div class="b">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
  <div class="m">Ø§Ù„Ø§Ø³Ù…: ${esc(d.customerName || "â€”")}</div>
  <div class="m">Ø§Ù„Ù‡Ø§ØªÙ: ${esc(d.customerPhone || "â€”")}</div>
  <div class="m">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${esc(d.customerAddress || "â€”")}</div>

  <div class="sep"></div>
  <div class="b">Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
  <div class="sep"></div>

  ${itemsHtml}

  <div class="sep"></div>
  <div class="totRow"><span>Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…</span><span>${Number(d.totalBefore||0).toFixed(2)}</span></div>
  <div class="totRow"><span>Ø§Ù„Ø®ØµÙ…</span><span>${Number(d.discount||0).toFixed(2)}</span></div>
  <div class="totRow"><span>Ø¨Ø¯ÙˆÙ† ØªÙˆØµÙŠÙ„</span><span>${Number(d.afterDiscount||0).toFixed(2)}</span></div>
  <div class="totRow"><span>Ø§Ù„ØªÙˆØµÙŠÙ„</span><span>${deliveryText}</span></div>
  <div class="totRow totMain"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span>${Number(d.finalTotal||0).toFixed(2)}</span></div>

  <div class="sep"></div>
  <div class="m">${esc(d.words)}</div>
  ${noteBlock}

  <div class="qr">
    <img src="assets/qr.png" alt="QR">
    <div class="m">Ø§Ù…Ø³Ø­ Ø§Ù„Ù€ QR Ù„Ù„ØªÙˆØ§ØµÙ„</div>
  </div>

  <div class="foot">Axentro â€“ All Rights Reserved 2024 Â©<br>By Ahmed Hamouda</div>
</div>
</body>
</html>`;
  }

  async function inlineAllImages(root){
    const imgs = Array.from(root.querySelectorAll("img"));
    async function toDataURL(url){
      try{
        const abs = new URL(url, location.href).toString();
        const res = await fetch(abs, { cache: "no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const blob = await res.blob();
        return await new Promise((resolve, reject)=>{
          const r = new FileReader();
          r.onload = ()=> resolve(r.result);
          r.onerror = reject;
          r.readAsDataURL(blob);
        });
      }catch(e){ return null; }
    }
    for(const img of imgs){
      const src = img.getAttribute("src") || "";
      if(!src || src.startsWith("data:")) continue;
      const dataUrl = await toDataURL(src);
      if(dataUrl) img.setAttribute("src", dataUrl);
    }
  }

  async function savePdfA4(){
    const d = getInvoiceData();
    const filename = `invoice_${(d.invNo||"SA").replace(/[^\w-]+/g,"_")}.pdf`;

    const holder = document.createElement("div");
    holder.style.position = "fixed";
    holder.style.left = "-99999px";
    holder.style.top = "0";
    holder.style.width = "210mm";
    holder.style.background = "#fff";
    holder.style.zIndex = "-1";

    holder.innerHTML = buildA4Html(d);
    document.body.appendChild(holder);

    await new Promise(r=> setTimeout(r, 150));
    await inlineAllImages(holder);

    const opt = {
      margin: 10,
      filename,
      image: { type: "jpeg", quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true, allowTaint: true, backgroundColor: "#ffffff" },
      jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
    };

    try{
      await html2pdf().set(opt).from(holder).save();
    }catch(e){
      console.error(e);
      alert("ÙØ´Ù„ Ø­ÙØ¸ PDF");
    }finally{
      holder.remove();
    }
  }

  document.getElementById('printA4Btn').addEventListener('click', ()=>{
    const d = getInvoiceData();
    openPrintWindow(buildA4Html(d), `ÙØ§ØªÙˆØ±Ø© ${d.invNo}`);
  });
  document.getElementById('savePdfA4Btn').addEventListener('click', savePdfA4);
  document.getElementById('thermal80Btn').addEventListener('click', ()=>{
    const d = getInvoiceData();
    openPrintWindow(buildThermalHtml(80, d), `ÙØ§ØªÙˆØ±Ø© ${d.invNo}`);
  });
  document.getElementById('thermal58Btn').addEventListener('click', ()=>{
    const d = getInvoiceData();
    openPrintWindow(buildThermalHtml(58, d), `ÙØ§ØªÙˆØ±Ø© ${d.invNo}`);
  });

  // ===== Scanner (ØªØ­Ø³ÙŠÙ†: ÙØªØ­ Ø§Ù„Ø®Ù„ÙÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ + ÙÙ„Ø§Ø´) =====
  const scanModal = document.getElementById('scanModal');
  const scanBtn = document.getElementById('scanBtn');
  const closeScanBtn = document.getElementById('closeScanBtn');
  const cameraSelect = document.getElementById('cameraSelect');
  const video = document.getElementById('video');
  const manualFillBtn = document.getElementById('manualFillBtn');
  const torchBtn = document.getElementById('torchBtn');

  let stream = null;
  let detector = null;
  let scanTimer = null;
  let track = null;

  function stopScan() {
    if(scanTimer) { clearInterval(scanTimer); scanTimer = null; }
    if(stream) {
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
    track = null;
    torchBtn.style.display = 'none';
    scanModal.classList.remove('show');
    scanModal.setAttribute('aria-hidden','true');
  }

  async function listCameras() {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d=>d.kind === 'videoinput');
    cameraSelect.innerHTML = '';
    cams.forEach((c, idx)=>{
      const opt = document.createElement('option');
      opt.value = c.deviceId;
      opt.textContent = c.label || ('Camera ' + (idx+1));
      cameraSelect.appendChild(opt);
    });
    return cams;
  }

  function pickBestCameraId(cams){
    if(!Array.isArray(cams) || !cams.length) return null;

    // Prefer "back/rear/environment"
    const preferred = cams.find(c=>{
      const label = String(c.label||"").toLowerCase();
      return /back|rear|environment/.test(label);
    });
    if(preferred) return preferred.deviceId;

    // Otherwise: last camera often is rear on mobiles
    return cams[cams.length - 1].deviceId;
  }

  async function startStream({deviceId=null, preferEnvironment=true}={}) {
    if(stream) {
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }

    // Try environment first
    let constraints = null;
    if(deviceId){
      constraints = { video: { deviceId: { exact: deviceId } }, audio:false };
    }else if(preferEnvironment){
      constraints = {
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1280 },
          height: { ideal: 720 }
        },
        audio:false
      };
    }else{
      constraints = { video: true, audio:false };
    }

    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    await video.play();
    track = stream.getVideoTracks()[0] || null;

    try {
      const caps = track && track.getCapabilities ? track.getCapabilities() : null;
      torchBtn.style.display = (caps && caps.torch) ? 'inline-block' : 'none';
    } catch(e) {
      torchBtn.style.display = 'none';
    }
  }

  async function openScan() {
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      toast('Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­');
      return;
    }

    scanModal.classList.add('show');
    scanModal.setAttribute('aria-hidden','false');

    // 1) Start environment first (better chance to open rear)
    try{
      await startStream({ deviceId: null, preferEnvironment: true });
    }catch(e){
      // fallback
      try{ await startStream({ deviceId: null, preferEnvironment: false }); }
      catch(e2){
        stopScan();
        toast('ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§');
        return;
      }
    }

    // 2) After permission, enumerate cameras + pick best
    let cams = [];
    try { cams = await listCameras(); } catch(e) {}
    const bestId = pickBestCameraId(cams);

    if(bestId && cameraSelect.value !== bestId){
      cameraSelect.value = bestId;
      try{ await startStream({ deviceId: bestId, preferEnvironment: false }); }catch(e){}
    }

    if('BarcodeDetector' in window) {
      try {
        detector = new window.BarcodeDetector({ formats: ['ean_13','ean_8','code_128','qr_code','upc_a','upc_e','code_39','code_93','itf'] });
      } catch(e) { detector = null; }
    } else {
      detector = null;
      toast("Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… BarcodeDetector. Ø§Ø³ØªØ®Ø¯Ù… Chrome.");
    }

    scanTimer = setInterval(async ()=>{
      if(!detector) return;
      try {
        const barcodes = await detector.detect(video);
        if(barcodes && barcodes.length) {
          const raw = String(barcodes[0].rawValue || '').trim();
          if(raw) {
            barcodeInp.value = raw;
            fillProductNameByBarcode();
            stopScan();
            toast('ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯');
          }
        }
      } catch(e) {}
    }, 180);
  }

  scanBtn.addEventListener('click', openScan);
  closeScanBtn.addEventListener('click', stopScan);
  scanModal.addEventListener('click', (e)=>{ if(e.target === scanModal) stopScan(); });

  cameraSelect.addEventListener('change', async ()=>{
    try { await startStream({ deviceId: cameraSelect.value, preferEnvironment:false }); }
    catch(e) { toast('ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§'); }
  });

  manualFillBtn.addEventListener('click', ()=>{
    stopScan();
    barcodeInp.focus();
  });

  torchBtn.addEventListener('click', async ()=>{
    if(!track) return;
    try {
      const settings = track.getSettings ? track.getSettings() : {};
      const torchOn = settings.torch === true;
      await track.applyConstraints({ advanced: [{ torch: !torchOn }] });
    } catch(e) {
      toast('Ø§Ù„ÙÙ„Ø§Ø´ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…');
    }
  });

  // init
  loadProducts().finally(()=>{
    render();
    resetItemInputs();
  });
})();
</script>
</body>
</html>
